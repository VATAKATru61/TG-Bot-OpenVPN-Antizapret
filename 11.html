<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>VPN WebApp</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            darkbg: '#161616',
            darkcard: '#151826',
            accent: '#26d694',
            bluebtn: '#2963ff',
            stroke: 'rgba(255,255,255,0.08)'
          }
        }
      }
    }
  </script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    html, body { background: #161616; color: #eef1f7; min-height: 100vh; font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    body.top-safe { padding-top: calc(env(safe-area-inset-top) + 64px); }
    .glass-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); }
    .safe-bottom { padding-bottom: calc(env(safe-area-inset-bottom) + 10px); }
    .tap { -webkit-tap-highlight-color: transparent; }
    .btn-ghost { background: rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); }
    .btn-ghost:active { transform: translateY(1px); }
    .btn-bottom { height: 56px; border-radius: 14px; }
    .btn-bottom.active { background: #2963ff; color: #fff; box-shadow: 0 8px 24px rgba(41,99,255,0.25); }

    /* Credit Card - Флип через анимацию */
    .card-3d { position: relative; perspective: 1000px; }
    .card-rotor { 
      position: relative; 
      width: 100%; 
      height: 210px; 
      transform-style: preserve-3d;
      transition: transform 0.6s cubic-bezier(.2,.8,.2,1.1);
      border-radius: 18px; 
      border: 1px solid transparent;
      border-color: transparent !important;
    }
    .card-3d.flipped .card-rotor { transform: rotateY(180deg) scale(1.02); }
    .card-3d{ will-change: transform; }
    .face { position: absolute; inset: 0; border-radius: 18px; overflow: hidden; display:flex; flex-direction:column; justify-content:flex-start; backface-visibility: hidden; -webkit-backface-visibility: hidden; }
    .front { z-index: 2; }
    .face.front { background-repeat: var(--bg-repeat, no-repeat); background-size: var(--bg-size, 100% 100%); background-position: var(--bg-position, 0 0); }
    .back { transform: rotateY(180deg); background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%); }

    /* Sample-style card for first tariff */
    .card-v1-front { 
      background: 
        radial-gradient(circle at 30% 40%, rgba(2, 185, 121, 0.8) 0%, transparent 50%),
        radial-gradient(circle at 70% 70%, rgba(24, 66, 90, 0.8) 0%, transparent 50%),
        linear-gradient(135deg, 
          #0D7761 0%,
          #017560 30%,
          #02B979 60%,
          #0E7969 80%,
          #18425A 100%
        );
      box-shadow: 
        0 20px 40px rgba(0, 0, 0, 0.3),
        0 15px 12px rgba(0, 0, 0, 0.22),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }
    .card-v1-back { 
      background: linear-gradient(135deg, 
        #148C73 0%,
        #0F826E 30%,
        #19C88C 60%,
        #1E8C7D 80%,
        #23506E 100%
      );
      box-shadow: 
        0 20px 40px rgba(0, 0, 0, 0.3),
        0 15px 12px rgba(0, 0, 0, 0.22),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }
    .card-v1-front:hover, .card-v1-back:hover {
      box-shadow: 
        0 35px 80px rgba(0, 0, 0, 0.4),
        0 25px 25px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    .card-v1-front::before, .card-v1-back::before {
      content: ""; position: absolute; inset: 0; pointer-events: none; z-index: 1;
      background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.3) 0%, 
        rgba(255, 255, 255, 0.1) 20%, 
        transparent 50%,
        rgba(0, 0, 0, 0.05) 70%,
        rgba(0, 0, 0, 0.1) 100%
      );
    }
    .card-label { align-self: flex-start; display:inline-block; color: rgba(255,255,255,0.95); font-size: 15px; font-weight: 600; letter-spacing: .6px; text-shadow: 0 2px 8px rgba(0,0,0,.35); padding: 6px 14px; border-radius: 12px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.28); backdrop-filter: blur(10px); }

    /* Цвета тарифов */
    .tier-1 {
      --card-gradient: 
        linear-gradient(to bottom, #018566 0%, #02C17C 100%),
        linear-gradient(to bottom, #015957 0%, #02AA74 100%),
        linear-gradient(to bottom, #313234 0%, #02936B 100%),
        linear-gradient(to bottom, #333436 0%, #0F836C 100%);
      --bg-repeat: no-repeat, no-repeat, no-repeat, no-repeat;
      --bg-size: 25% 100%, 25% 100%, 25% 100%, 25% 100%;
      --bg-position: 0% 0, 25% 0, 50% 0, 75% 0;
      background: var(--card-gradient);
    }
    .tier-2 { --card-gradient: linear-gradient(45deg, #ff6600 0%, #ff6600 50%, #661a00 90%); --bg-repeat: no-repeat; --bg-size: 100% 100%; --bg-position: 0 0; background: var(--card-gradient); }
    .tier-3 { --card-gradient: linear-gradient(45deg, #ff3333 0%, #ff3333 50%, #660000 90%); --bg-repeat: no-repeat; --bg-size: 100% 100%; --bg-position: 0 0; background: var(--card-gradient); }
    .tier-none { --card-gradient: linear-gradient(45deg, #9ca3af 0%, #9ca3af 50%, #4b5563 90%); --bg-repeat: no-repeat; --bg-size: 100% 100%; --bg-position: 0 0; background: var(--card-gradient); }
    .cc-bg { --card-gradient: linear-gradient(45deg, #22c55e 0%, #22c55e 50%, #14532d 90%); --bg-repeat: no-repeat; --bg-size: 100% 100%; --bg-position: 0 0; background: var(--card-gradient); }
    .tier-mid { --card-gradient: linear-gradient(45deg, #ff6600 0%, #ff6600 50%, #661a00 90%); --bg-repeat: no-repeat; --bg-size: 100% 100%; --bg-position: 0 0; background: var(--card-gradient); }
    .tier-vip { --card-gradient: linear-gradient(45deg, #ff3333 0%, #ff3333 50%, #660000 90%); --bg-repeat: no-repeat; --bg-size: 100% 100%; --bg-position: 0 0; background: var(--card-gradient); }
    .tier-mid2 { --card-gradient: linear-gradient(45deg, #ff9900 0%, #ff9900 50%, #663300 90%); --bg-repeat: no-repeat; --bg-size: 100% 100%; --bg-position: 0 0; background: var(--card-gradient); }
    .cc-overlay::after { content:""; position:absolute; inset:0; pointer-events:none; border-radius:inherit; background: var(--card-gradient); background-repeat: var(--bg-repeat, no-repeat); background-size: var(--bg-size, 100% 100%); background-position: var(--bg-position, 0 0); filter: brightness(1.18) saturate(1.05); padding: 1.5px; -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); -webkit-mask-composite: xor; mask-composite: exclude; }
    .cc-chip { width:38px; height:28px; border-radius:6px; background: linear-gradient(180deg,#d6d2c4,#9d998a); box-shadow: inset 0 0 0 2px rgba(0,0,0,0.15); }
    .cc-net { position:absolute; bottom:12px; right:14px; display:flex; gap:6px; }
    .cc-net span { width:14px; height:14px; border-radius:50%; background: rgba(255,255,255,0.85); box-shadow: 0 0 0 2px rgba(0,0,0,0.1) inset; }
    .cc-water { position:absolute; top:12px; right:14px; font-weight:800; letter-spacing:2px; font-size:1.1rem; color:rgba(255,255,255,0.22); }
    .cc-tariff { font-weight: 800; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 1px 0 rgba(0,0,0,0.25); }

    /* Glare */
    .glare-streak { display: none !important; }
    .mag-stripe { position: absolute; left: 0; right: 0; top: 25px; height: 50px; background: #000000; box-shadow: inset 0 3px 6px rgba(0,0,0,0.9), inset 0 -3px 6px rgba(0,0,0,0.9), 0 1px 1px rgba(255,255,255,0.03); display: flex; align-items: center; justify-content: center; gap: 10px; padding: 0 20px; }

    /* Black-Blue 3D card style */
    .bb-front { background: linear-gradient(135deg, #2c3e50 0%, #000000 100%); color: #ffffff; box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
    .bb-back  { background: linear-gradient(135deg, #000000 0%, #2c3e50 100%); color: #ffffff; box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
    .face.back.bb-back { padding-top: 12px; padding-bottom: 12px; }
    .bb-front::before, .bb-back::before { content:''; position:absolute; top:-50%; right:-30%; width:200px; height:200px; background: rgba(255,255,255,0.08); border-radius:50%; filter: blur(4px); z-index:0; }
    .bb-header { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom: 40px; position:relative; z-index:1; }
    .bb-plan-type { font-size: 16px; font-weight: 500; opacity: 0.9; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
    .bb-logo { font-size: 16px; font-weight: 600; opacity: 0.8; letter-spacing: 1px; color: rgba(255,255,255,0.95); text-shadow: none; white-space: nowrap; }
    .logo-shimmer { position:relative; overflow:hidden; }
    .logo-shimmer::after { content:""; position:absolute; top:0; left:-140%; width:140%; height:100%; background: linear-gradient(115deg, rgba(255,255,255,0) 0%, rgba(255,255,255,.75) 50%, rgba(255,255,255,0) 70%); filter: blur(1px); transform:skewX(-20deg); animation: shimmer 1.8s ease-in-out infinite; pointer-events:none; }
    @keyframes shimmer { 0% { left:-140%; } 100% { left:140%; } }
    .bb-bottom { display:flex; align-items:flex-end; justify-content:space-between; position:relative; z-index:1; margin-top:auto; }
    .bb-owner-info { display:flex; flex-direction:column; gap:4px; }
    .bb-owner-label { font-size: 12px; opacity: 0.8; font-weight: 400; }
    .bb-owner-name { font-size: 16px; font-weight: 700; letter-spacing: .5px; }
    .bb-expiry-info { display:flex; flex-direction:column; align-items:flex-end; gap:4px; }
    .bb-expiry-label { font-size: 12px; opacity: 0.8; font-weight: 400; }
    .bb-expiry-date { font-size: 16px; font-weight: 700; }
    .bb-details { position:relative; z-index:1; display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top: 56px; font-size:12px; }
    .bb-details .bb-row { display:flex; align-items:center; justify-content:space-between; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); border-radius: 10px; padding: 6px 10px; }
    .bb-details .bb-left { display:flex; align-items:center; gap:8px; color: rgba(255,255,255,0.9); font-weight: 500; }
    .bb-details .bb-label { opacity: 0.9; }
    .bb-details .bb-val { color:#fff; font-weight: 700; text-align:right; }
    /* Flip hint */
    .flip-hint { position:absolute; left:50%; transform:translateX(-50%); bottom:6px; font-size:10px; letter-spacing:.2px; color:rgba(255,255,255,.92); text-shadow:0 1px 2px rgba(0,0,0,.4); animation: flipBlink 1.2s ease-in-out infinite; pointer-events:none; }
    @keyframes flipBlink { 0%,100%{ opacity:.25; transform:translateX(-50%) translateY(0); } 50%{ opacity:1; transform:translateX(-50%) translateY(-1px); } }
    /* Keep header texts from pushing layout */
    .card-label {
      max-width: 60%;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      white-space: normal;
      word-break: break-word;
    }
    .bb-logo { max-width: 40%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    /* Compact magnetic stripe to save space */
    .mag-stripe { top: 18px; height: 44px; }

    /* Family (tier-2) */
    .card-v2-front {
      background:
        radial-gradient(ellipse 120% 80% at 80% 30%, rgba(255, 206, 190, 0.4) 0%, transparent 70%),
        radial-gradient(ellipse 100% 60% at 30% 30%, rgba(245, 180, 162, 0.3) 0%, transparent 60%),
        linear-gradient(135deg,
          rgb(231, 99, 93) 0%,
          rgb(232, 115, 95) 15%,
          rgb(232, 127, 98) 35%,
          rgb(234, 142, 101) 55%,
          rgb(233, 153, 94) 75%,
          rgb(236, 162, 97) 100%
        );
      box-shadow: 0 20px 40px rgba(0,0,0,0.3), 0 15px 12px rgba(0,0,0,0.22), inset 0 1px 0 rgba(255,255,255,0.1);
    }
    .card-v2-back {
      background: linear-gradient(135deg,
        rgb(231, 99, 93) 0%,
        rgb(232, 120, 98) 25%,
        rgb(234, 140, 102) 50%,
        rgb(235, 155, 96) 75%,
        rgb(234, 164, 94) 100%
      );
      box-shadow: 0 20px 40px rgba(0,0,0,0.3), 0 15px 12px rgba(0,0,0,0.22), inset 0 1px 0 rgba(255,255,255,0.1);
    }
    .card-v2-front::before, .card-v2-back::before { content:''; position:absolute; inset:0; z-index:1; pointer-events:none; background: linear-gradient(115deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.05) 40%, transparent 70%); backdrop-filter: blur(0.5px); opacity: 0.7; }
    .card-v2-front::after, .card-v2-back::after { content:''; position:absolute; inset:-2px; border-radius:20px; background: linear-gradient(135deg, rgba(255,225,200,0.8) 0%, rgba(255,195,160,0.6) 25%, rgba(250,160,120,0.8) 50%, rgba(240,130,95,0.6) 75%, rgba(255,180,140,0.8) 100%); z-index:-1; opacity:0; transition: opacity .3s ease; filter: blur(4px); }
    .card-v2-front:hover::after, .card-v2-back:hover::after { opacity: .6; }
    /* Corporate (tier-3) */
    .card-v3-front { background: radial-gradient(ellipse 100% 60% at 10% 30%, rgba(77, 159, 217, 0.6) 0%, transparent 70%), radial-gradient(ellipse 120% 80% at 70% 30%, rgba(194,203,255,0.4) 0%, transparent 65%), radial-gradient(ellipse 140% 90% at 30% 140%, rgba(123,191,255,0.3) 0%, transparent 60%), linear-gradient(125deg, rgb(22,143,250) 0%, rgb(42,131,249) 15%, rgb(64,117,247) 35%, rgb(86,105,244) 55%, rgb(112,89,242) 75%, rgb(154,69,224) 100%); box-shadow: 0 20px 40px rgba(0,0,0,0.3), 0 15px 12px rgba(0,0,0,0.22), inset 0 1px 0 rgba(255,255,255,0.1); }
    .card-v3-back { background: linear-gradient(125deg, rgb(22,143,250) 0%, rgb(48,127,248) 25%, rgb(70,114,247) 50%, rgb(94,99,243) 75%, rgb(130,78,240) 100%); box-shadow: 0 20px 40px rgba(0,0,0,0.3), 0 15px 12px rgba(0,0,0,0.22), inset 0 1px 0 rgba(255,255,255,0.1); }
    .card-v3-front::before, .card-v3-back::before { content:''; position:absolute; inset:0; z-index:1; pointer-events:none; background: linear-gradient(115deg, rgba(255,255,255,0.12) 0%, rgba(255,255,255,0.03) 40%, transparent 70%); backdrop-filter: blur(0.5px); opacity:.8; }
    .card-v3-front::after, .card-v3-back::after { content:''; position:absolute; inset:-2px; border-radius:20px; background: linear-gradient(125deg, rgba(60,180,255,0.8) 0%, rgba(120,150,255,0.6) 25%, rgba(160,120,255,0.8) 50%, rgba(180,100,255,0.6) 75%, rgba(200,80,250,0.8) 100%); z-index:-1; opacity:0; transition: opacity .3s ease; filter: blur(6px); }
    .card-v3-front:hover::after, .card-v3-back:hover::after { opacity:.7; animation: glow-pulse 2s ease-in-out infinite alternate; }
    @keyframes glow-pulse { 0% { filter: blur(6px); transform: scale(1);} 100% { filter: blur(10px); transform: scale(1.02);} }
    .nav-page{ opacity:0; transition: opacity 200ms ease; will-change: opacity; }
    .nav-page.active{ opacity:1; }
    /* Day/Night Toggle styles */
    .toggle{display:block;text-align:center;user-select:none}
    .toggle--checkbox{display:none}
    .toggle--btn{display:block;margin:0 auto;font-size:1.4em;transition:all 350ms ease-in;cursor:pointer}
    .toggle--btn,.toggle--checkbox,.toggle--feature{transition:all 250ms ease-in}
    .toggle--btn:before,.toggle--btn:after,.toggle--feature:before,.toggle--feature:after{content:'';display:block;transition:all 250ms ease-in}
    .toggle--daynight .toggle--btn{position:relative;height:70px;width:125px;border-radius:70px;border:5px solid #1c1c1c;background-color:#3c4145}
    .toggle--daynight .toggle--btn:before{position:absolute;top:2px;left:4px;width:56px;height:56px;border-radius:50%;background-color:#fff;border:5px solid #e3e3c7}
    .toggle--daynight .toggle--btn:after{position:absolute;top:62%;left:calc(125px - 56px - (5px*2) - 20px);z-index:10;width:calc(56px/5);height:calc(56px/5);opacity:0;background-color:#fff;border-radius:50%;box-shadow:#fff 0 0,#fff 3px 0,#fff 6px 0,#fff 9px 0,#fff 11px 0,#fff 14px 0,#fff 16px 0,#fff 21px -1px 0 1px,#fff 16px -7px 0 -2px,#fff 7px -7px 0 1px,#d3d3d3 0 0 0 4px,#d3d3d3 6px 0 0 4px,#d3d3d3 11px 0 0 4px,#d3d3d3 16px 0 0 4px,#d3d3d3 21px -1px 0 5px,#d3d3d3 16px -7px 0 1px,#d3d3d3 7px -7px 0 5px;transition:opacity 100ms ease-in}
    .toggle--daynight .toggle--feature{display:block;position:absolute;top:9px;left:52.5%;z-index:20;width:4px;height:4px;border-radius:50%;background-color:#fff;box-shadow:rgba(255,255,255,0.1) 30px -3px 0 0,rgba(255,255,255,0.1) 12px 10px 0 -1px,#fff 38px 18px 0 1px,rgba(255,255,255,0.1) 32px 34px 0 0,#fff 20px 24px 0 -1.5px,rgba(255,255,255,0.1) 5px 38px 0 1px;animation:starry_star 5s ease-in-out infinite}
    .toggle--daynight .toggle--feature:before{position:absolute;top:-2px;left:-25px;width:18px;height:18px;background-color:#fff;border-radius:50%;border:5px solid #e3e3c7;box-shadow:#e3e3c7 -28px 0 0 -3px,#e3e3c7 -8px 24px 0 -2px;transform-origin:-6px 130%}
    .toggle--daynight .toggle--checkbox:checked + .toggle--btn{background-color:#9ee3fb;border:5px solid #86c3d7}
    .toggle--daynight .toggle--checkbox:checked + .toggle--btn:before{left:calc(125px - 56px - (5px*2) - 4px);background-color:#ffdf6d;border:5px solid #e1c348}
    .toggle--daynight .toggle--checkbox:checked + .toggle--btn:after{opacity:1;animation:bounceIn .60s ease-in-out .10s backwards}
    .toggle--daynight .toggle--checkbox:checked + .toggle--btn > .toggle--feature{opacity:0;box-shadow:rgba(255,255,255,0.1) 30px -3px 0 -4px,rgba(255,255,255,0.1) 12px 10px 0 -5px,#fff 38px 18px 0 -3px,rgba(255,255,255,0.1) 32px 34px 0 -4px,#fff 20px 24px 0 -5.5px,rgba(255,255,255,0.1) 5px 38px 0 -3px;animation:none}
    .toggle--daynight .toggle--checkbox:checked + .toggle--btn > .toggle--feature:before{left:25px;transform:rotate(70deg)}
    @keyframes starry_star{50%{background-color:rgba(255,255,255,0.1);box-shadow:#fff 30px -3px 0 0,#fff 12px 10px 0 -1px,rgba(255,255,255,0.1) 38px 18px 0 1px,#fff 32px 34px 0 0,rgba(255,255,255,0.1) 20px 24px 0 -1.5px,#fff 5px 38px 0 1px}}
    @keyframes bounceIn{0%{opacity:0;transform:scale(.3)}50%{opacity:1;transform:scale(1.1)}55%{transform:scale(1.1)}75%{transform:scale(.9)}100%{opacity:1;transform:scale(1)}}
    /* Light theme overrides */
    .light body{ background:#ffffff; color:#0b0d14; }
    .light .glass-card{ background:rgba(255,255,255,0.8); border:1px solid rgba(0,0,0,0.06); }
    .light #marketSegment{ background:#e7e9ef; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.06); }
    .light #marketSegment button{ color:#4b5563; }
    .light #marketSegment button.text-white{ color:#111827; }
    .light #marketSegment button.bg-\[\#3F3F46\]{ background:#d1d5e5 !important; color:#111827 !important; }
    .light .card-rotor{ box-shadow: 0 10px 24px rgba(0,0,0,0.08); }
    .light .card-label{ background:rgba(0,0,0,0.06); border-color: rgba(0,0,0,0.15); color:#111827; }
    .light .text-slate-400{ color:#6b7280 !important; }
    .light .text-slate-200{ color:#374151 !important; }
    .light .btn-ghost{ background:rgba(0,0,0,0.04); border-color: rgba(0,0,0,0.06); color:#111827; }
    .light #importModal .modal-btn{ background:#e7e9ef; color:#111827; border-color:#d1d5db; }
    .light #extendModal .tap{ background:#e7e9ef; border-color:#d1d5db; color:#111827; }
    .light #topupModal .pay-btn{ background:#2963ff; color:#fff; }
    .light .border-stroke{ border-color: rgba(0,0,0,0.08) !important; }
    .light .bg-darkbg{ background:#ffffff !important; }
    .light .bg-\[\#27272A\]{ background:#F4F4F5 !important; border-color:#E4E4E7 !important; color:#0b0d14; }
    .light nav .grid.grid-cols-3{ background:rgba(255,255,255,0.92) !important; border-color:#e5e7eb !important; }
    /* Text color overrides */
    .light .text-white{ color:#0b0d14 !important; }
    .light .text-white\/90,.light .text-white\/80,.light .text-white\/70,.light .text-white\/60{ color:#1f2937 !important; }
    .light .text-slate-300{ color:#4b5563 !important; }
    .light .text-slate-200{ color:#374151 !important; }
    .light .text-slate-400{ color:#6b7280 !important; }
    /* Borders */
    .light .border-stroke{ border-color: rgba(0,0,0,0.08) !important; }
    .light .border-white\/10,.light .border-white\/15,.light .border-white\/28{ border-color: rgba(0,0,0,0.08) !important; }
    /* Dark hex bg overrides */
    .light .bg-\[\#27272A\]{ background:#d1d5e5 !important; color:#0b0d14; border-color:#c7cfdd !important; }
    .light .bg-\[\#121425\], .light .bg-\[\#121425\]\/92{ background:#ffffff !important; border-color:#e5e7eb !important; }
    .light .bg-\[\#0c0e14\]{ background:#ffffff !important; color:#111827; border-color:#e5e7eb !important; }
    .light .hover\:bg-\[\#303035\]:hover{ background:#e7e9ef !important; }
    /* Bottom nav */
    .light nav .grid.grid-cols-3{ background:rgba(255,255,255,0.92) !important; border-color:#e5e7eb !important; }
    .light #vpnSegment .tap{ background:#d1d5e5; color:#111827; }
    .light #vpnSegment .tap.text-\[\#9aa1ae\]{ color:#4b5563; }
    .light .card-3d .face.front .label,
    .light .card-3d .face.front .value,
    .light .card-3d .face.front .date,
    .light .card-3d .face.front .brand,
    .light .card-3d .face.front .card-label,
    .light .card-3d .face.back,
    .light .card-3d .face.back *{ color:#ffffff !important; }
    .card-3d .mag-stripe a{ color:#ffffff !important; }
    .card-3d .mag-stripe button{ color:#ffffff !important; }
    /* Decorative noise and corner brackets */
    .face.front.decor-noise{ position: relative; }
    .face.front.decor-noise::after{ content:""; position:absolute; inset:0; pointer-events:none; z-index:1; opacity:.06; background-image: radial-gradient(rgba(255,255,255,.55) 1px, transparent 1px), radial-gradient(rgba(0,0,0,.55) 1px, transparent 1px); background-size:3px 3px, 4px 4px; background-position:0 0, 1px 1px; mix-blend-mode:soft-light; }
    .face.front.corner-accent{ position: relative; }
    .face.front.corner-accent::before, .face.front.corner-accent::after{ content:""; position:absolute; width:16px; height:16px; border:2px solid var(--accent, rgba(255,255,255,.35)); border-radius:4px; z-index:2; pointer-events:none; }
    .face.front.corner-accent::before{ top:10px; left:10px; border-right:none; border-bottom:none; opacity:.9; }
    .face.front.corner-accent::after{ bottom:10px; right:10px; border-left:none; border-top:none; opacity:.9; }
    .price-pill{ display:inline-block; padding:2px 8px; border-radius:10px; font-size:12px; line-height:1.2; background: rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.24); color:#fff; }
    .light .price-pill{ background: rgba(0,0,0,.06); border-color: rgba(0,0,0,.12); color:#0b0d14; }
    .light #extendModal .relative,
    .light #importModal .relative,
    .light #topupModal .relative,
    .light #devicesModal .relative,
    .light #manageModal .relative,
    .light #qrModal .relative{ background:#ffffff; border-color:#e5e7eb; color:#0b0d14; }
    .light #extendModal .text-slate-400,
    .light #importModal .text-slate-400,
    .light #topupModal .text-slate-400,
    .light #devicesModal .text-slate-400,
    .light #manageModal .text-slate-400,
    .light #qrModal .text-slate-400{ color:#6b7280 !important; }
    .light #extendModal .tap,
    .light #importModal .modal-btn,
    .light #manageModal .tap{ background:#e5e7f0; color:#111827; border-color:#d1d5db; transition: background-color .15s ease, border-color .15s ease; }
    .light #extendModal .tap:hover,
    .light #importModal .modal-btn:hover,
    .light #manageModal .tap:hover{ background:#dbe1ea; border-color:#cbd5e1; }
    .light #topupModal input{ background:#f3f4f6; border-color:#e5e7eb; color:#111827; }
    .light #topupModal .btn-ghost{ background:#eef2f7; color:#111827; border-color:#e5e7eb; }
    .light .card-3d .face.front .text-emerald-100\/90,
    .light .card-3d .face.front .text-emerald-100,
    .light .card-3d .face.front .text-emerald-200{ color:#ffffff !important; }
    /* Market: remove card drop shadows in both themes */
    #page_market .card-rotor{ box-shadow: none !important; }
    /* VPN subscriptions: remove card shadows */
    #vpnCardsContainer .card-rotor{ box-shadow:none !important; }
    #vpnCardsContainer .face.front, #vpnCardsContainer .face.back{ box-shadow:none !important; }
    /* TopUp modal steppers */
    #topupModal .step-btn{ width:28px; height:28px; border-radius:8px; background:#3F3F46; color:#fff; border:1px solid #3A3A3D; display:inline-flex; align-items:center; justify-content:center; font-weight:700; line-height:1; }
    #topupModal .step-btn:hover{ background:#303035; }
    .light #topupModal .step-btn{ background:#e7e9ef; color:#111827; border-color:#d1d5db; }
    .light #topupModal .step-btn:hover{ background:#dbe1ea; }
    /* Hide native spinners (WebKit/Firefox) */
    #topupModal input[type=number]::-webkit-outer-spin-button,
    #topupModal input[type=number]::-webkit-inner-spin-button{ -webkit-appearance: none; margin:0; }
    #topupModal input[type=number]{ -moz-appearance: textfield; appearance: textfield; }
    /* Light: bottom nav white text and icons */
    .light nav .btn-bottom, .light nav .btn-bottom span, .light nav .btn-bottom svg{ color:#ffffff !important; fill:#ffffff !important; }
    /* Light: dark nav background */
    .light nav .grid.grid-cols-3{ background:rgba(18,20,37,0.92) !important; border-color:rgba(255,255,255,0.12) !important; }
    /* Light: ensure primary action buttons keep white text */
    .light button.bg-bluebtn, .light .extend-btn, .light #topupBtn{ color:#ffffff !important; }
    /* Safeguard: ensure no card border/shadow on Market */
    #page_market .card-rotor{ box-shadow:none !important; border:none !important; }

    /* Market: kill face shadows and overlays to avoid side stripes */
    #page_market .face.front, #page_market .face.back{ box-shadow:none !important; }
    #page_market .card-v1-front::before, #page_market .card-v1-front::after,
    #page_market .card-v1-back::before,  #page_market .card-v1-back::after,
    #page_market .card-v2-front::before, #page_market .card-v2-front::after,
    #page_market .card-v2-back::before,  #page_market .card-v2-back::after,
    #page_market .card-v3-front::before, #page_market .card-v3-front::after,
    #page_market .card-v3-back::before,  #page_market .card-v3-back::after{ content:none !important; display:none !important; }
    #page_market .cc-overlay::after{ content:none !important; display:none !important; }

    /* Light: force white text on VPN card faces */
    .light #page_vpn .card-3d .face.front, .light #page_vpn .card-3d .face.front *{ color:#ffffff !important; }
    /* Light: VPN segment bar and buttons to F4F4F5 */
    .light #vpnSegment{ background:#F4F4F5 !important; border-color:#E4E4E7 !important; }
    .light #vpnSegment .tap{ background:#F4F4F5 !important; color:#111827 !important; }
    .light #vpnSegment .tap.text-\[\#9aa1ae\]{ color:#4b5563 !important; }
    /* Light: modal list items to F4F4F5 */
    .light #extendModal .tap{ background:#F4F4F5 !important; border-color:#E4E4E7 !important; color:#111827 !important; }
    .light #extendModal .tap:hover{ background:#EAEAEC !important; }
    .light #importModal .modal-btn{ background:#F4F4F5 !important; border-color:#E4E4E7 !important; color:#111827 !important; }
    .light #importModal .modal-btn:hover{ background:#EAEAEC !important; }

    /* Light: VPN info blocks and links to F4F4F5 */
    .light #vpnInfo .bg-\[\#27272A\]{ background:#F4F4F5 !important; border-color:#E4E4E7 !important; color:#0b0d14; }
    .light #trafficCard{ background:#F4F4F5 !important; border-color:#E4E4E7 !important; color:#0b0d14; }
    .light #trafficChart{ background:#f3f4f6 !important; border-color:#e5e7eb !important; }
    .light #trafficCard .text-slate-400{ color:#0b0d14 !important; }
    /* Light: toast notifications readable */
    .light #toast{ background:#e5e7eb !important; color:#111827 !important; border:1px solid #d1d5db; }
    /* Light: manage modal button overrides */
    .light #manageModal #btnExtend{ background:#16a34a !important; color:#ffffff !important; }
    #manageModal #btnDeleteSub{ background:#dc2626 !important; color:#0b0d14 !important; }
    /* QR: neutral button in light theme */
    .light #manageModal #btnQr{ background:#e5e7f0 !important; color:#111827 !important; border:1px solid #d1d5db; }
    .light #subSelect{ background:#f3f4f6 !important; border-color:#e5e7eb !important; color:#111827 !important; }
    /* Light: under-card tiles to F4F4F5 */
    .light #page_market .bg-\[\#27272A\], .light #page_vpn .bg-\[\#27272A\]{ background:#F4F4F5 !important; border-color:#E4E4E7 !important; color:#0b0d14; }

    /* Light: generic light grey surfaces */
    .light .surface-light{ background:#F4F4F5 !important; border-color:#E4E4E7 !important; color:#0b0d14; }
    #subCard .legacy-owner{ display:none !important; }
    /* New card tone and corner accents */
    .card-tone{ position:relative; background:#111316; border:1px solid rgba(255,255,255,0.08); border-radius:20px; color:#fff; }
    .light .card-tone{ background:#ffffff; border:1px solid #e5e7eb; color:#0b0d14; }
    .card-tone.corner-accent::after{ content:""; position:absolute; inset:0; pointer-events:none; border-radius:inherit; background: radial-gradient( 160px 160px at 110% -10%, var(--accent, #22c55e) 0%, transparent 60%), radial-gradient( 220px 220px at -10% 110%, color-mix(in srgb, var(--accent, #22c55e) 30%, transparent) 0%, transparent 70%); opacity:.85; }
    .light .card-tone.corner-accent::after{ opacity:.75; }
    .tier-1{ --accent:#22c55e; }
    .tier-2{ --accent:#f59e0b; }
    .tier-3{ --accent:#ef4444; }
    .tier-4{ --accent:#eab308; }
  </style>
  <style>
    /* New stripe card styles */
    .vpn-card{width:320px;max-width:100%;height:180px;border-radius:16px;position:relative;overflow:hidden;padding:20px;isolation:isolate;background:radial-gradient(circle, rgba(0,0,0,0.08) 1px, transparent 1px),linear-gradient(180deg,#f9fafb,#eef1f6);background-size:12px 12px,100% 100%;color:#111;box-shadow:0 10px 28px rgba(0,0,0,.14), inset 0 0 0 1px rgba(0,0,0,.06);animation:breath 9s ease-in-out infinite;--c1:#6a5acd;--c2:#7f5af0;--c3:#ff7eb6}
    .vpn-card--fluid{width:100%;height:210px;border-radius:inherit}
    @keyframes breath{0%,100%{transform:scale(1)}50%{transform:scale(1.01)}}
    .vpn-card.palette-teal{--c1:#1fbfb8;--c2:#2bd4a0;--c3:#8be28b}
    .vpn-card.palette-ocean{--c1:#0084ff;--c2:#00c2ff;--c3:#00ffd1}
    .vpn-card.palette-lime{--c1:#8bc34a;--c2:#aeea00;--c3:#00e676}
    .vpn-card.palette-frost{--c1:#8aa2ff;--c2:#a7c5ff;--c3:#d1f4ff}
    .vpn-card.palette-fire{--c1:#ff512f;--c2:#f09819;--c3:#ffd36e}
    .vpn-card.palette-citrus{--c1:#ff9a00;--c2:#ff8c8c;--c3:#ffee00}
    .vpn-card.palette-berry{--c1:#ff69b4;--c2:#db7093;--c3:#ff1493}
    .vpn-card.palette-summer{--c1:#ffd700;--c2:#ffa500;--c3:#ff4500}
    .vpn-card.palette-forest{--c1:#228b22;--c2:#32cd32;--c3:#90ee90}
    .vpn-card.palette-autumn{--c1:#cd853f;--c2:#ff4500;--c3:#ffd700}
    .vpn-card.palette-pastel{--c1:#ffb6c1;--c2:#ffc0cb;--c3:#ffe4e1}
    .vpn-card.palette-cherry{--c1:#ff1493;--c2:#ff69b4;--c3:#ffc0cb}
    .vpn-card.palette-volcano{--c1:#ff4500;--c2:#ff8c00;--c3:#ffd700}
    .vpn-card.palette-desert{--c1:#f4a460;--c2:#cd853f;--c3:#ffdab9}
    .vpn-card.palette-arctic{--c1:#00bfff;--c2:#add8e6;--c3:#e0ffff}
    .vpn-card .header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:42px;position:relative;z-index:1}
    .vpn-card .plan-type{font-size:15px;font-weight:700;letter-spacing:.4px;opacity:.95;display:inline-block;padding:3px 8px;border-radius:8px;background:linear-gradient(90deg,var(--c1),var(--c3));color:#fff;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    .vpn-card .logo{font-size:16px;font-weight:800;letter-spacing:1px;color:#111}
    .vpn-card .spacer{height:2.2em}
    .vpn-card .bottom-info{display:flex;justify-content:space-between;align-items:flex-end;position:relative;z-index:1}
    .vpn-card .owner-info{display:flex;flex-direction:column;gap:4px}
    .vpn-card .owner-label,.vpn-card .expiry-label{font-size:12px;opacity:.9}
    .vpn-card .owner-name,.vpn-card .expiry-date{font-size:16px;font-weight:800;letter-spacing:.5px}
    .vpn-card .stripe{position:absolute;top:-10%;bottom:-10%;right:18px;width:48px;border-radius:12px;overflow:hidden;z-index:0;background:linear-gradient(180deg,#0f172a,#111827 60%,#1f2937),linear-gradient(180deg,var(--c1),var(--c2) 55%,var(--c3));background-blend-mode:screen}
    .vpn-card .stripe::before{content:"";position:absolute;inset:0;background:repeating-linear-gradient(90deg, rgba(255,255,255,.12) 0 2px, rgba(255,255,255,0) 2px 6px),radial-gradient(120% 100% at 50% 50%, rgba(0,0,0,.18) 0%, rgba(0,0,0,0) 60%);background-size:24px 100%,100% 100%;animation:slideX 3s linear infinite;mix-blend-mode:normal}
    @keyframes slideX{to{background-position:24px 0,0 0}}
    /* Dark theme compatibility */
    .dark .vpn-card{color:#fff}
  </style>
  <style>
    @media (pointer:fine){
      #page_vpn .card-v2-front::before, #page_vpn .card-v2-back::before,
      #page_vpn .card-v2-front::after,  #page_vpn .card-v2-back::after,
      #page_vpn .card-v3-front::before, #page_vpn .card-v3-front::after,
      #page_vpn .card-v3-back::before,  #page_vpn .card-v3-back::after,
      #page_vpn .cc-overlay::after{ content:none !important; display:none !important; }
      #page_vpn .card-label{ backdrop-filter: none !important; }
    }
    #page_vpn #subCard{ display:none !important; }
    #page_vpn #owner_name{ display:none !important; }
  </style>
</head>
<body class="bg-darkbg min-h-screen pt-3 pb-24 px-0 flex flex-col items-center top-safe">
  <!-- Header -->
  <header class="w-full max-w-md mx-auto flex items-center justify-between px-4 pt-1 pb-2">
    <div class="w-9 h-9 rounded-full overflow-hidden border border-stroke">
      <img id="avatarImg" src="https://i.imgur.com/FQ4Qh7X.jpeg" alt="avatar" class="w-full h-full object-cover">
    </div>
    <div id="brandTitle" class="text-sm font-semibold text-slate-200">VPN</div>
    <div class="toggle toggle--daynight" id="themeToggleWrap" style="transform:scale(0.6);transform-origin:center;">
      <input type="checkbox" id="toggle--daynight" class="toggle--checkbox">
      <label class="toggle--btn" for="toggle--daynight"><span class="toggle--feature"></span></label>
    </div>
  </header>

  <!-- Page: VPN -->
  <main id="page_vpn" class="nav-page active w-full max-w-md mx-auto">
    <!-- VPN Cards Container -->
    <div id="vpnCardsContainer">
      <!-- Карты подписок будут добавлены динамически -->
    </div>
    <!-- Legacy Card (для обратной совместимости) -->
    <section id="subCard" class="card-3d mx-4 mb-4 hidden">
      <div class="card-rotor border border-white/15 rounded-2xl shadow-xl">
        <!-- Front -->
        <div class="face front bb-front px-5 py-5">
          <div class="bb-header">
            <div class="bb-plan-type" id="plan_name">—</div>
            <div class="bb-logo" id="wm_text">VPN</div>
          </div>
          <div class="bb-bottom">
            <div class="bb-owner-info">
              <div class="bb-owner-label">Владелец</div>
              <div class="bb-owner-name" id="owner_name">—</div>
            </div>
            <div class="bb-expiry-info">
              <div class="bb-expiry-label">Заканчивается</div>
              <div class="bb-expiry-date" id="expiry_short">—</div>
            </div>
          </div>
        </div>
        <!-- Back -->
        <div class="face back bb-back px-5 py-5">
          <div class="mag-stripe" aria-hidden="true">
            <a id="openLinkBtn" href="#" target="_blank" rel="noopener" class="flex-1 text-white/70 text-[11px] font-mono tracking-tight whitespace-nowrap overflow-hidden text-ellipsis text-center px-2" style="direction:ltr">
              <span id="sub_link_box">—</span>
            </a>
            <button id="backCopyBtn" class="tap rounded bg-white/10 hover:bg-white/20 text-white/70 w-7 h-7 flex items-center justify-center transition-colors flex-shrink-0" aria-label="Копировать">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4">
                <path d="M16 1H6a2 2 0 00-2 2v10h2V3h10V1zm3 4H10a2 2 0 00-2 2v12a2 2 0 002 2h9a2 2 0 002-2V7a2 2 0 00-2-2zm0 14H10V7h9v12z"/>
              </svg>
            </button>
          </div>
        </div>
        <!-- Glare streak overlay -->
        <div class="glare-streak" aria-hidden="true"></div>
      </div>
    </section>

    <!-- Segment control -->
    <section class="mx-4 mt-2 mb-2 flex justify-center hidden" id="vpnSegWrap">
      <div id="vpnSegment" class="segment flex gap-2 bg-[#27272A] rounded-[14px] px-2 py-1 shadow-[inset_0_0_0_1px_rgba(255,255,255,0.06)]">
        <button data-seg="info" class="tap px-3 py-2 rounded-[10px] font-semibold text-[13px] text-white bg-[#3F3F46] shadow-[0_6px_10px_rgba(0,0,0,0.35),inset_0_0_0_1px_rgba(255,255,255,0.06)]">Информация</button>
        <button data-seg="availability" class="tap px-3 py-2 rounded-[10px] font-semibold text-[13px] text-[#9aa1ae]">Доступность</button>
      </div>
    </section>

<!-- Info section (actions + links вместе) -->
<section id="vpnInfo" class="mx-4 space-y-3 hidden">
  <!-- Actions -->
<div class="rounded-2xl bg-[#27272A] p-2">
  <button id="copy_btn" class="tap w-full px-3 py-3 flex items-center gap-2 text-white hover:bg-[#303035] border-b border-[#3A3A3D]">
	<img src="https://speedupnet.vip/copyr.png" alt="copy" class="inline w-6 h-6 mr-2">
    <span class="font-medium">Скопировать VPN ключ</span>
    <span class="ml-auto text-white">›</span>
  </button>
  <button id="import_btn" class="tap w-full px-3 py-3 flex items-center gap-2 text-white hover:bg-[#303035] border-b border-[#3A3A3D]">
	<img src="https://speedupnet.vip/add.png" alt="copy" class="inline w-6 h-6 mr-2">
    <span class="font-medium">Добавить подписку в приложение</span>
    <span class="ml-auto text-white">›</span>
  </button>
  <button id="manage_btn" class="tap w-full px-3 py-3 flex items-center gap-2 text-white hover:bg-[#303035] border-b border-[#3A3A3D]">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 mr-2"><path d="M12 2a1 1 0 01.96.73l.62 2.2c.35.1.7.23 1.03.4l2-1.2a1 1 0 011.29.27l1.5 2a1 1 0 01-.07 1.25l-1.46 1.6c.1.35.18.72.23 1.1l2.22.63a1 1 0 01.74.96v2.5a1 1 0 01-.74.96l-2.22.63c-.05.38-.13.75-.23 1.1l1.46 1.6a1 1 0 01.07 1.25l-1.5 2a1 1 0 01-1.29.27l-2-1.2c-.33.17-.68.3-1.03.4l-.62 2.2A1 1 0 0112 22h-2a1 1 0 01-.96-.73l-.62-2.2a6.8 6.8 0 01-1.03-.4l-2 1.2a1 1 0 01-1.29-.27l-1.5-2a1 1 0 01.07-1.25l1.46-1.6c-.1-.35-.18-.72-.23-1.1L1.68 14A1 1 0 01.94 13v-2.5a1 1 0 01.74-.96l2.22-.63c.05-.38.13-.75.23-1.1L2.67 6.2a1 1 0 01-.07-1.25l1.5-2a1 1 0 011.29-.27l2 1.2c.33-.17.68-.3 1.03-.4l.62-2.2A1 1 0 0110 2h2zm0 6a4 4 0 100 8 4 4 0 000-8z"/></svg>
    <span class="font-medium">Управление подпиской</span>
    <span class="ml-auto text-white">›</span>
  </button>
  <button id="guide_btn" class="tap w-full px-3 py-3 flex items-center gap-2 text-white hover:bg-[#303035]">
	<img src="https://speedupnet.vip/inst.png" alt="copy" class="inline w-6 h-6 mr-2">
    <span class="font-medium">Открыть инструкцию</span>
    <span class="ml-auto text-white">›</span>
  </button>
</div>


  <!-- Links -->
  <div id="trafficCard" class="rounded-2xl bg-[#27272A] p-3 mt-3 hidden">
    <div id="trafficTitle" class="text-[12px] text-slate-400 mb-2">Расход трафика</div>
    <div class="w-full h-24 rounded-xl border border-[#3A3A3D] bg-[#0c0e14] overflow-hidden flex items-end" id="trafficChart"></div>
  </div>
  <div class="rounded-2xl bg-[#27272A] p-2">
    <a id="privacyLink" class="tap w-full px-3 py-3 flex items-center gap-2 hover:bg-[#303035] border-b border-[#3A3A3D]" target="_blank" rel="noopener">	<img src="https://speedupnet.vip/conf.png" alt="copy" class="inline w-6 h-6 mr-2">Политика конфиденциальности</a>
    <a id="offerLink" class="tap w-full px-3 py-3 flex items-center gap-2 hover:bg-[#303035] border-b border-[#3A3A3D]" target="_blank" rel="noopener">	<img src="https://speedupnet.vip/ofert.png" alt="copy" class="inline w-6 h-6 mr-2">Публичная оферта</a>
    <a id="supportLink" class="tap w-full px-3 py-3 flex items-center gap-2 hover:bg-[#303035]" target="_blank" rel="noopener">	<img src="https://speedupnet.vip/tp.png" alt="copy" class="inline w-6 h-6 mr-2">Написать в техподдержку</a>
  </div>
</section>

<!-- Availability -->
<section id="vpnAvailability" class="mx-4 mb-4 hidden">
  <div class="rounded-xl glass-card px-4 py-3">
    <div class="text-[12px] text-slate-400 mb-2">Доступность серверов</div>
    <div id="availList" class="space-y-2 text-sm text-slate-200"><div class="text-slate-500">Загрузка…</div></div>
  </div>
</section>




    <section id="vpnAvailability" class="mx-4 mb-4 hidden">
      <div class="rounded-xl glass-card px-4 py-3">
        <div class="text-[12px] text-slate-400 mb-2">Доступность серверов</div>
        <div id="availList" class="space-y-2 text-sm text-slate-200"><div class="text-slate-500">Загрузка…</div></div>
      </div>
    </section>
  </main>

  <!-- Manage Subscription Modal -->
  <div id="manageModal" class="fixed inset-0 z-50 hidden grid place-items-center">
    <div class="absolute inset-0 bg-[#0B0D14]/70"></div>
    <div class="relative w-[92%] max-w-md rounded-2xl bg-[#161616] border border-[#3A3A3D] p-4 shadow-2xl">
      <div class="text-base font-semibold mb-3" id="manageTitle">Управление подпиской</div>
      <div id="subSelectWrap" class="mb-2 hidden">
        <label class="text-xs text-slate-400">Выберите подписку</label>
        <select id="subSelect" class="mt-1 w-full rounded-xl bg-[#0c0e14] border border-stroke px-3 py-2 outline-none"></select>
      </div>
      <div class="grid grid-cols-1 gap-2 mb-2">
        <button id="btnExtend" class="tap rounded-xl bg-green-600 hover:bg-green-700 text-white font-semibold py-2">Продлить подписку</button>
        <button id="btnDeleteSub" class="tap rounded-xl font-semibold py-2">Удалить подписку</button>
        <button id="btnDevices" class="tap rounded-xl bg-[#3F3F46] hover:bg-[#303035] text-white font-semibold py-2">Мои устройства</button>
        <button id="btnQr" class="tap rounded-xl font-semibold py-2 bg-[#3F3F46] hover:bg-[#303035] text-white">Показать QR‑код</button>
      </div>
      <div class="flex gap-2">
        <button id="closeManage" class="tap flex-1 rounded-xl btn-ghost py-2">Закрыть</button>
      </div>
    </div>
  </div>

  <!-- Devices Modal -->
  <div id="devicesModal" class="fixed inset-0 z-50 hidden grid place-items-center">
    <div class="absolute inset-0 bg-[#0B0D14]/70"></div>
    <div class="relative w-[92%] max-w-md rounded-2xl bg-[#161616] border border-[#3A3A3D] p-4 shadow-2xl max-h-[90vh] overflow-y-auto">
      <div class="text-base font-semibold mb-3">Мои устройства</div>
      <div class="-mx-1">
        <div id="devicesBox" class="min-w-full px-1"></div>
      </div>
      <div class="flex gap-2 mt-3">
        <button id="resetDevices" class="tap flex-1 rounded-xl bg-red-600 hover:bg-red-700 text-white py-2">Сбросить привязку</button>
        <button id="closeDevices" class="tap flex-1 rounded-xl btn-ghost py-2">Закрыть</button>
      </div>
    </div>
  </div>

  <!-- QR Modal -->
  <div id="qrModal" class="fixed inset-0 z-50 hidden grid place-items-center">
    <div class="absolute inset-0 bg-[#0B0D14]/70"></div>
    <div class="relative w-[92%] max-w-md rounded-2xl bg-[#161616] border border-[#3A3A3D] p-4 shadow-2xl">
      <div class="text-base font-semibold mb-3">QR‑код</div>
      <div id="qrBox" class="w-full flex justify-center items-center">
        <img id="qrImg" src="" alt="QR" style="max-width:100%;height:auto;border-radius:12px;border:1px solid rgba(255,255,255,0.1)"/>
      </div>
      <div class="flex gap-2 mt-3">
        <button id="closeQr" class="tap flex-1 rounded-xl btn-ghost py-2">Закрыть</button>
      </div>
    </div>
  </div>

  <!-- Page: Market -->
  <main id="page_market" class="nav-page w-full max-w-md mx-auto hidden">
    <section class="mx-4 mt-1 mb-3">
      <div id="marketTabs" class="flex flex-wrap gap-2"></div>
    </section>
    <section id="marketGrid" class="mx-4 grid grid-cols-1 gap-3 pb-2"></section>
  </main>

  <!-- Page: Profile -->
  <main id="page_profile" class="nav-page w-full max-w-md mx-auto hidden">
    <section class="mx-4 mt-2 mb-3 text-center">
      <div id="balance_text" class="text-4xl font-bold">— ₽</div>
      <div class="text-sm text-slate-400 mb-3">Ваш баланс</div>
      <div class="grid grid-cols-1 gap-2">
        <button id="topupBtn" class="tap rounded-xl bg-bluebtn text-white font-semibold py-3">Пополнить</button>
      </div>
    </section>
    <section class="mx-4 mb-2">
      <div class="grid grid-cols-2 gap-2">
        <button id="prof_tab_hist" class="tap rounded-xl btn-ghost py-2 font-semibold active-tab">История</button>
        <button id="prof_tab_refs" class="tap rounded-xl btn-ghost font-semibold py-2">Рефералы</button>
      </div>
    </section>
    <section id="prof_hist" class="mx-4 rounded-xl glass-card px-4 py-3 mb-4">
      <div class="text-[11px] text-slate-400 mb-2">ПОПОЛНЕНИЯ</div>
      <div id="txList" class="space-y-2 text-sm text-slate-200"><div class="text-slate-500">Записей нет</div></div>
    </section>
    <section id="prof_refs" class="hidden mx-4 rounded-xl glass-card px-4 py-3 mb-6">
      <div class="text-[11px] text-slate-400 mb-2">РЕФЕРАЛЫ</div>
      <div id="refList" class="space-y-2 text-sm text-slate-200"><div class="text-slate-500">Нет данных</div></div>
    </section>
  </main>

  <!-- Import Modal -->
  <div id="importModal" class="fixed inset-0 z-50 hidden grid place-items-center">
    <div class="absolute inset-0 bg-[#0B0D14]/70"></div>
    <div class="relative w-[92%] max-w-md rounded-2xl bg-[#161616] border border-[#3A3A3D] p-4 shadow-2xl">
      <div class="text-base font-semibold mb-3">Добавить подписку в приложение</div>
      <div id="importApps" class="grid grid-cols-1 gap-2 mb-1"></div>
      <style>.modal-btn{background:#27272A;border:1px solid #3A3A3D;color:#fff;border-radius:12px;padding:.5rem .75rem}.modal-btn:hover{background:#303035}</style>
      <div class="text-[11px] text-slate-400 mb-2">Откроется выбранное приложение/сайт для импорта.</div>
      <div class="flex gap-2">
        <button id="closeImport" class="tap flex-1 rounded-xl btn-ghost py-2">Закрыть</button>
      </div>
    </div>
  </div>

  <!-- Extend Modal - выбор тарифа для продления -->
  <div id="extendModal" class="fixed inset-0 z-50 hidden grid place-items-center">
    <div class="absolute inset-0 bg-[#0B0D14]/70"></div>
    <div class="relative w-[92%] max-w-md rounded-2xl bg-[#161616] border border-[#3A3A3D] p-4 shadow-2xl">
      <div class="text-base font-semibold mb-3">Выберите срок продления</div>
      <div id="extendTariffs" class="grid grid-cols-1 gap-2 mb-3"></div>
      <div class="flex gap-2">
        <button id="iPaidBtn" class="tap flex-1 rounded-xl btn-ghost py-2">Я оплатил</button>
        <button id="closeExtend" class="tap flex-1 rounded-xl btn-ghost py-2">Отмена</button>
      </div>
    </div>
  </div>

  <!-- TopUp Modal -->
  <div id="topupModal" class="fixed inset-0 z-50 hidden grid place-items-center">
    <div class="absolute inset-0 bg-[#0B0D14]/70"></div>
    <div class="relative w-[92%] max-w-md rounded-2xl bg-[#161616] border border-[#3A3A3D] p-4 shadow-2xl">
      <div class="text-base font-semibold mb-3">Пополнить баланс</div>
      <div class="mb-3">
        <label class="text-xs text-slate-400">Сумма, ₽</label>
        <div class="relative">
          <input id="topupAmount" type="number" min="10" step="10" value="100" class="mt-1 w-full rounded-xl bg-[#0c0e14] border border-stroke px-3 py-2 pr-20 outline-none" />
          <div class="absolute right-2 top-1/2 -translate-y-1/2 flex gap-1">
            <button id="decAmount" type="button" class="tap step-btn">−</button>
            <button id="incAmount" type="button" class="tap step-btn">+</button>
          </div>
        </div>
      </div>
      <div id="payMethods" class="grid grid-cols-2 gap-2 mb-3"></div>
      <style>.pay-btn{background:#2963ff;color:#fff;border-radius:12px;padding:.5rem .75rem}.pay-btn:hover{background:#2156e0}</style>
      <div class="text-[11px] text-slate-400">Если нет способов оплаты — используйте бота оплаты.</div>
      <div class="flex gap-2">
        <button id="closeTopup" class="tap flex-1 rounded-xl btn-ghost py-2">Отмена</button>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="fixed bottom-0 inset-x-0 z-50 safe-bottom">
    <div class="mx-auto max-w-md px-3">
      <div class="grid grid-cols-3 gap-2 bg-[#121425]/92 backdrop-blur-md border border-stroke shadow-2xl rounded-2xl p-2">
        <button id="nav_vpn" class="tap btn-bottom flex flex-col items-center justify-center text-slate-300 active">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M12 2c.3 0 .6.1.9.2l7 3c.6.3 1.1.9 1.1 1.7 0 8-4.7 12.3-8.6 13.8-.3.1-.6.1-.8 0C7.7 19.2 3 14.9 3 6.9c0-.8.5-1.4 1.1-1.7l7-3c.3-.1.6-.2.9-.2z"/></svg>
          <span class="text-[11px] font-semibold mt-0.5">VPN</span>
        </button>
        <button id="nav_market" class="tap btn-bottom flex flex-col items-center justify-center text-slate-300">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M7 4h10l1 3h3v2h-1l-2 9H7L5 9H4V7h3l1-3zm3 3h4l-.5-1.5h-3L10 7z"/></svg>
          <span class="text-[11px] font-semibold mt-0.5">Магазин</span>
        </button>
        <button id="nav_profile" class="tap btn-bottom flex flex-col items-center justify-center text-slate-300">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5"><path d="M12 12a5 5 0 100-10 5 5 0 000 10zm-7 9a7 7 0 0114 0v1H5v-1z"/></svg>
          <span class="text-[11px] font-semibold mt-0.5">Профиль</span>
        </button>
      </div>
    </div>
  </nav>

  <!-- Global Fade Overlay for transitions -->
  <div id="fadeOverlay" class="fixed inset-0 z-40 pointer-events-none opacity-0 transition-opacity duration-220" style="background:rgba(0,0,0,0.45)"></div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-36 left-1/2 -translate-x-1/2 px-3 py-2 rounded-lg bg-black/80 text-[12px] text-white opacity-0 pointer-events-none transition-opacity duration-200">Скопировано</div>

  <script>
    // Helpers
    function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
    function haptic(kind){ try{ const h=tg&&tg.HapticFeedback; if(!h) return; if(kind==='selection'){ h.selectionChanged(); } else if(kind==='heavy'){ h.impactOccurred('heavy'); } else if(kind==='medium'){ h.impactOccurred('medium'); } else { h.impactOccurred('light'); } }catch(_){} }
    // MSK time helpers
    function mskNow(){ try{ return new Date(new Date().toLocaleString('en-US',{ timeZone:'Europe/Moscow' })); }catch(_){ return new Date(Date.now()+3*3600*1000); } }
    function mskTodayLabel(){ const d=mskNow(); const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); return dd+'.'+mm; }
    function scheduleMskMidnight(){ try{ const now=mskNow(); const next=new Date(now); next.setHours(24,0,5,0); const ms=next-now; if(ms>0) setTimeout(()=>{ try{ renderTrafficChart(); }catch(_){ } scheduleMskMidnight(); }, ms); }catch(_){ } }

    // Nav routing
    const PAGES = { nav_vpn: 'page_vpn', nav_market: 'page_market', nav_profile: 'page_profile' };
    let NAV_BUSY=false;
    function setActiveNav(id){
      if(NAV_BUSY) return; NAV_BUSY=true;
      const overlay=document.getElementById('fadeOverlay');
      const targets=Object.keys(PAGES);
      const nextKey=id;
      // Показать оверлей
      if(overlay){ overlay.style.transition='opacity 140ms ease'; overlay.style.opacity='1'; }
      // Обновить кнопки сразу
      targets.forEach(k=>{
        const btn=document.getElementById(k);
        const isTarget=(k===nextKey);
        btn.classList.toggle('active', isTarget);
        btn.classList.toggle('text-white', isTarget);
        btn.classList.toggle('text-slate-300', !isTarget);
      });
      // Через один тик: мгновенно заменить страницы без двойного потока
      setTimeout(async()=>{
        targets.forEach(k=>{
          const page=document.getElementById(PAGES[k]);
          const on=(k===nextKey);
          page.classList.toggle('hidden', !on);
          page.classList.toggle('active', on);
        });
        // Refresh dynamic data on nav
        try{
          if(nextKey==='nav_profile' || nextKey==='nav_vpn'){
            const meR=await api('me'); if(meR.ok){ const me=await meR.json(); document.getElementById('balance_text').textContent = fmtMoney(me.balance||0); }
          }
          if(nextKey==='nav_vpn'){
            const subsR = await api('subscription'); const subs = subsR.ok?await subsR.json():[];
            const tariffsR = await api('tariffs'); TARIFFS = tariffsR.ok?await tariffsR.json():[];
            renderAllSubscriptions(subs, ME||{});
            CURRENT_SUB = subs && subs.length ? subs[0] : null; HAS_SUB=!!(subs&&subs.length);
            try{ renderTrafficChart(); }catch(_){ }
          }
        }catch(_){ }
        // Снять оверлей и завершить
        setTimeout(()=>{ if(overlay){ overlay.style.opacity='0'; } NAV_BUSY=false; }, 160);
      }, 50);
    }
    Object.keys(PAGES).forEach(k=>{ const el=document.getElementById(k); if(!el) return; el.onclick=()=>{ haptic('selection'); setActiveNav(k); }; });
    // profile subtabs
    document.getElementById('prof_tab_hist')?.addEventListener('click',()=>{ document.getElementById('prof_hist')?.classList.remove('hidden'); document.getElementById('prof_refs')?.classList.add('hidden'); });
    document.getElementById('prof_tab_refs')?.addEventListener('click',()=>{ document.getElementById('prof_hist')?.classList.add('hidden'); document.getElementById('prof_refs')?.classList.remove('hidden'); });

    // Flip & 3D tilt + glare (safe-guarded for missing legacy card)
    const subCard = document.getElementById('subCard');
    let rotor = null;
    try { rotor = subCard ? subCard.querySelector('.card-rotor') : null; } catch(_) { rotor = null; }
    let motionAsked = false;
    let flipAngle = 0; // 0 or 180
    let tiltX = 0, tiltY = 0; // degrees
    let isFlipping = false;
    const MAX_TILT_Y = 9, MAX_TILT_X = 4;
    function applyTransform(){
      if(!rotor) return;
      const posX = 50 + (tiltY / MAX_TILT_Y) * 40;
      const posY = 50;
      rotor.style.setProperty('--streak-pos', posX.toFixed(1)+'% '+posY.toFixed(1)+'%');
      rotor.style.setProperty('--streak-angle', '105deg');
    }
    async function askMotion(){ try{ if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') { await DeviceMotionEvent.requestPermission(); } if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') { await DeviceOrientationEvent.requestPermission(); } }catch(_){ } }
    function flipCard(to){ const willFlip = (to===true ? true : to===false ? false : !subCard.classList.contains('flipped')); subCard.classList.toggle('flipped', willFlip); isFlipping = true; window.setTimeout(()=>{ isFlipping = false; }, 600); try{ const h = (window.Telegram && Telegram.WebApp && Telegram.WebApp.HapticFeedback); h && h.impactOccurred('medium'); }catch(_){ } if(!motionAsked){ motionAsked=true; askMotion(); } }
    function applyTierToBothFaces(tier){ const front = subCard.querySelector('.face.front'); const back = subCard.querySelector('.face.back'); if(front) { front.classList.remove('glass-card','tier-mid','tier-mid2','tier-vip','cc-bg','cc-overlay'); const cls = cardClassForTier(tier); if(cls==='glass-card'){ front.classList.add('cc-bg'); } else { front.classList.add(cls); } front.classList.add('cc-overlay'); } }
    function applyTierByClass(cls){ const front = subCard.querySelector('.face.front'); if(front) { front.classList.remove('glass-card','tier-mid','tier-mid2','tier-vip','cc-bg','tier-1','tier-2','tier-3','tier-none','cc-overlay'); front.classList.add(cls); if(cls !== 'tier-none') { front.classList.add('cc-overlay'); } } }
    if(subCard){ subCard.addEventListener('click', (e)=>{ const backIds=['backCopyBtn','openLinkBtn']; if(backIds.includes(e.target.id)) return; haptic('selection'); flipCard(); }); }
    function updateShine(xp, yp){ if(!subCard) return; try{ const faces = subCard.querySelectorAll('.face'); faces.forEach(face=>{ face.style.setProperty('--sx', (xp*100)+'%'); face.style.setProperty('--sy', (yp*100)+'%'); }); }catch(_){ } }
    // Блик при движении устройства
    window.addEventListener('deviceorientation', (e)=>{ try{ if (isFlipping || !rotor) return; const xRatio = clamp((e.gamma||0)/8, -1, 1); const yRatio = clamp(((e.beta||0)-45)/8, -1, 1); const xp = 0.5 + xRatio*0.5; const yp = 0.5 + yRatio*0.5; tiltY = xRatio * MAX_TILT_Y; applyTransform(); updateShine(xp, yp); }catch(_){ } }, { passive:true });
    // Fallback iOS Telegram: devicemotion
    window.addEventListener('devicemotion', (e)=>{ try{ if (isFlipping || !rotor) return; const g=e.accelerationIncludingGravity||{}; const gx=g.x||0, gy=g.y||0; const xp = 0.5 + clamp(gx/9.8, -1, 1)*0.5; const yp = 0.5 + clamp(-gy/9.8, -1, 1)*0.5; tiltY = clamp(gx/9.8, -1, 1) * MAX_TILT_Y; applyTransform(); updateShine(xp, yp); }catch(_){ } }, { passive:true });
    updateShine(0.55, 0.35);
    // Блик при движении мыши
    if(rotor){
      rotor.addEventListener('pointermove', (e)=>{ try{ if (isFlipping) return; const r = rotor.getBoundingClientRect(); const xp = Math.max(0, Math.min(1, (e.clientX - r.left) / Math.max(1,r.width))); const yp = Math.max(0, Math.min(1, (e.clientY - r.top) / Math.max(1,r.height))); tiltY = (xp-0.5)*20; applyTransform(); updateShine(xp, yp); }catch(_){ } }, { passive:true });
      rotor.addEventListener('mouseleave', ()=>{ if (isFlipping) return; tiltY = 0; applyTransform(); });
    }

    // API helpers
    const API = '/mini_lk/api';
    const tg = window.Telegram && window.Telegram.WebApp;
    function openExternal(url){ try{ if(tg && typeof tg.openLink==='function'){ tg.openLink(url, { try_instant_view:false }); return; } }catch(_){ } try{ const w=window.open(url, '_blank'); if(!w){ location.href=url; } }catch(_){ location.href=url; } }
    let CONFIG=null, CURRENT_SUB=null, TARIFFS=[]; let HAS_SUB=false; let ME=null;
    function computeOwnerName(){ try{ const u = (ME||{}); if(u.username){ return '@'+u.username; } if(u.first_name){ return u.first_name; } const tu = (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user : null; if(tu){ if(tu.username){ return '@'+tu.username; } if(tu.first_name){ return tu.first_name; } } }catch(_){ } return '—'; }
    let OWNER_NAME='—'; function refreshOwnerName(){ try{ OWNER_NAME = computeOwnerName(); const el=document.getElementById('owner_name'); if(el){ el.textContent = OWNER_NAME; } const elb=document.getElementById('owner_name_back'); if(elb){ elb.textContent = OWNER_NAME; } }catch(_){ OWNER_NAME='—'; } }
    function syncOwnerNameToCards(){ try{ const els=document.querySelectorAll('.owner-name-text'); const txt = OWNER_NAME || computeOwnerName(); els.forEach(el=>{ el.textContent = txt; }); const elb=document.getElementById('owner_name_back'); if(elb){ elb.textContent = txt; } }catch(_){ } }
    let LAST_TRAFFIC_CID=null;
    let PENDING_PAYMENT=false, PAY_WATCH_TIMER=null, PAY_WATCH_COUNT=0; window.LAST_BUY_TARIFF=null; window.LAST_EXTEND=window.LAST_EXTEND||null;
    async function attemptAutoRenew(){ try{ const r=await api('auto_renew_if_pending'); if(r && r.ok){ const js=await r.json().catch(()=>({})); if(r.status===200 && (js.status==='ok' || js.new_expiry_time || js.client_id || js.link)){ try{ const subsR=await api('subscription'); const subs = subsR.ok?await subsR.json():[]; renderAllSubscriptions(subs, ME||{}); }catch(_){ } showToast('Готово'); return true; } if(r.status===402 || (js&&js.status==='insufficient')){ return false; } }
      // Fallback: if pending was cleared by webhook, try to complete by balance
      try{ const meR=await api('me'); if(!meR.ok) return false; const me=await meR.json(); const bal=me.balance||0; if(window.LAST_EXTEND && window.LAST_EXTEND.tariff_id){ const tid=window.LAST_EXTEND.tariff_id; const t=(TARIFFS||[]).find(x=>String(x.id)===String(tid)); const price=t?(t.price_rub||0):0; if(bal>=price){ const er=await api('extend', window.LAST_EXTEND); if(er.ok){ try{ const subsR=await api('subscription'); const subs = subsR.ok?await subsR.json():[]; renderAllSubscriptions(subs, ME||{}); }catch(_){ } showToast('Подписка продлена'); return true; } } }
        if(window.LAST_BUY_TARIFF && window.LAST_BUY_TARIFF.tariff_id){ const tid=window.LAST_BUY_TARIFF.tariff_id; const price=window.LAST_BUY_TARIFF.price||0; if(bal>=price){ const br=await api('buy', {tariff_id: tid}); if(br.ok){ try{ const subsR=await api('subscription'); const subs = subsR.ok?await subsR.json():[]; renderAllSubscriptions(subs, ME||{}); }catch(_){ } showToast('Подписка оформлена'); window.LAST_BUY_TARIFF=null; return true; } } } }catch(_){ }
      return false; }catch(_){ return false; } }
    function startAutoRenewWatch(){ try{ PENDING_PAYMENT=true; PAY_WATCH_COUNT=0; if(PAY_WATCH_TIMER) clearInterval(PAY_WATCH_TIMER); PAY_WATCH_TIMER=setInterval(async()=>{ PAY_WATCH_COUNT++; const ok=await attemptAutoRenew(); if(ok || PAY_WATCH_COUNT>30){ clearInterval(PAY_WATCH_TIMER); PAY_WATCH_TIMER=null; PENDING_PAYMENT=false; } }, 2000); }catch(_){ } }
    try{ document.addEventListener('visibilitychange', ()=>{ try{ if(!document.hidden && PENDING_PAYMENT){ attemptAutoRenew(); } }catch(_){ } }); }catch(_){ }
    function setText(id, val){ const el=document.getElementById(id); if(el) el.textContent = val; }
    function fmtDateNoYear(ts){ try{ const d=new Date(ts*1000); return String(d.getDate()).padStart(2,'0')+'/'+String(d.getMonth()+1).padStart(2,'0'); }catch(_){ return '—'; } }
    function fmtMoney(n){ try{ return (Math.round((n||0)*100)/100)+'₽'; }catch(_){ return '— ₽'; } }
    function bestLink(sub){ return (sub && (sub.sub_url || sub.link || sub.remnawave_link)) || ''; }
    function showToast(text){ const t=document.getElementById('toast'); if(!t) return; t.textContent=text||'Готово'; t.style.opacity='1'; setTimeout(()=>{ t.style.opacity='0'; }, 1200); }
    async function api(action, extra={}){ return fetch(API, { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify(Object.assign({action},extra)) }); }
    // Autoscale brand text (bb-logo) to fit its box (no wrap)
    function autoscaleBrandEl(el){ try{ if(!el) return; const maxPx=20, basePx=16, minPx=10; el.style.whiteSpace='nowrap'; el.style.fontSize = maxPx+'px'; // try bigger first
      // shrink if overflow
      while (parseFloat(el.style.fontSize)>minPx && el.scrollWidth>el.clientWidth){ const cur=parseFloat(el.style.fontSize)||basePx; el.style.fontSize=(cur-0.5)+'px'; }
      // if plenty of room and still small, gently grow up to max
      while ((el.scrollWidth+12)<=el.clientWidth && (parseFloat(el.style.fontSize)||basePx) < maxPx){ const cur=parseFloat(el.style.fontSize)||basePx; el.style.fontSize=(cur+0.5)+'px'; if(el.scrollWidth>el.clientWidth){ el.style.fontSize=cur+'px'; break; } }
    }catch(_){ } }
    // Gradients palette
    const CARD_GRADIENTS = [
      'linear-gradient(135deg, #00b894 0%, #0984e3 100%)',
      'linear-gradient(135deg, #fd79a8 0%, #fdcb6e 100%)',
      'linear-gradient(135deg, #0086ff 0%, #8f7fff 100%)',
      'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
      'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)',
      'linear-gradient(135deg, #4a90e2 0%, #1a365d 100%)',
      'linear-gradient(135deg, #ff6b35 0%, #f7931e 100%)',
      'linear-gradient(135deg, #2c3e50 0%, #4ca1af 100%)',
      'linear-gradient(135deg, #232526 0%, #1a1a1a 100%)',
      'linear-gradient(135deg, #0f2027 0%, #203a43 100%)',
      'linear-gradient(135deg, #141e30 0%, #243b55 100%)'
    ];
    function pickGradientRandom(){ return CARD_GRADIENTS[(Math.random()*CARD_GRADIENTS.length)|0]; }
    function hashInt(s){ let h=2166136261>>>0; const t=String(s); for(let i=0;i<t.length;i++){ h^=t.charCodeAt(i); h=Math.imul(h,16777619); } return h>>>0; }
    function pickGradientByKey(key){ const idx = hashInt(String(key)) % CARD_GRADIENTS.length; return CARD_GRADIENTS[idx]; }
    // Palettes for stripe cards
    const PALETTE_CLASSES = [
      'palette-teal','palette-ocean','palette-lime','palette-frost','palette-fire',
      'palette-citrus','palette-berry','palette-summer','palette-forest','palette-autumn',
      'palette-pastel','palette-cherry','palette-volcano','palette-desert','palette-arctic'
    ];
    function pickPaletteRandom(){ return PALETTE_CLASSES[(Math.random()*PALETTE_CLASSES.length)|0]; }
    function pickPaletteByKey(key){ const idx = hashInt(String(key)) % PALETTE_CLASSES.length; return PALETTE_CLASSES[idx]; }
    async function attemptUrlLogin(){ return false; }
    async function ensureAuth(){ try{ const st=await api('auth_status'); if(st.ok){ const js=await st.json(); if(js.ok) return true; } }catch(_){ } try{ tg&&tg.ready&&tg.ready(); }catch(_){ } const initData = (tg && tg.initData) || new URLSearchParams(location.search).get('tgWebAppData'); if(initData){ const r=await api('telegram_callback',{init_data:initData}); return r.ok; } return false; }

    function mountTariffTabs(){ 
      const wrap=document.getElementById('marketTabs'); 
      if(!wrap) return; 
      const names=(TARIFFS||[]).map(t=>({id:t.id,name:t.name,price:t.price_rub||0})); 
      wrap.innerHTML='';
      const tabs=document.createElement('nav'); 
      tabs.setAttribute('aria-label','Тарифы');
      tabs.className='tabs flex gap-3 px-1 py-1 overflow-x-auto no-scrollbar';
      tabs.style.webkitOverflowScrolling='touch';
      names.forEach((t,idx)=>{ 
        const b=document.createElement('button'); 
        b.className='tab tap px-4 py-2 rounded-[14px] font-semibold text-[13px] whitespace-nowrap bg-transparent border border-transparent text-[#9aa4b2]'; 
        b.textContent=t.name||('Тариф '+t.id); 
        b.dataset.tid=String(t.id); 
        if(idx===0){ b.classList.add('active','bg-[#1a2230]','border','#2a3547','text-white'); }
        tabs.appendChild(b); 
      });
      wrap.appendChild(tabs);
      const grid=document.getElementById('marketGrid'); 
      if(!grid) return; 
      grid.innerHTML='';
      const slides=document.createElement('div'); 
      slides.id='tariffSlides'; 
      slides.className='flex overflow-x-auto snap-x snap-mandatory gap-3'; 
      slides.style.scrollSnapType='x mandatory'; 
      slides.style.webkitOverflowScrolling='touch';
      slides.style.scrollbarWidth = 'none';
      slides.style.msOverflowStyle = 'none';
      slides.style.cssText += '::-webkit-scrollbar { display: none; }';
      names.forEach((t,idx)=>{ 
        const tariff=(TARIFFS||[]).find(x=>x.id===t.id)||{}; 
        const cls=cardClassByIndex(idx);
        const price = tariff.price_rub!=null?tariff.price_rub:0;
        const devs = tariff.device_limit!=null?tariff.device_limit:'∞';
        const traf = tariff.traffic_limit!=null?(tariff.traffic_limit+' ГБ'):'∞';
        const days = tariff.duration_days || 30;
        const slide=document.createElement('div'); 
        slide.className='snap-center shrink-0 w-full'; 
        slide.dataset.tid=String(t.id);
        const cardWrapper = document.createElement('div');
        cardWrapper.className = 'card-3d mb-3';
        cardWrapper.id = `market-card-${idx}`;
        const rotor = document.createElement('div');
        rotor.className = 'card-rotor rounded-[20px]';
        rotor.style.height = '220px';
        const front = document.createElement('div');
        const isV1 = (idx === 0);
        const isV2 = (idx === 1);
        const isV3 = (idx === 2);
        front.className = (isV1 ? 'face front px-5 py-5 card-v1-front' : isV2 ? 'face front px-5 py-5 card-v2-front' : isV3 ? 'face front px-5 py-5 card-v3-front' : `face front px-5 py-5 ${cls} cc-overlay`);
        const perDay = days>0 ? Math.round((price/days)*100)/100 : price;
        front.innerHTML = `
          <div class="brand absolute right-5 top-7 font-extrabold text-[44px] tracking-[2px] text-white/15 select-none">VPN</div>
          <div class=\"card-label text-sm\">${tariff.name || 'Тариф'}</div>
          <div class="flex justify-between items-end mt-auto pt-6">
            <div>
              <div class="label text-white/85 text-[14px]">Стоимость</div>
              <div class="value text-[22px] font-extrabold">${price} ₽</div>
              <div class="mt-1 price-pill">≈ ${perDay} ₽/день</div>
            </div>
            <div class="exp text-right">
              <div class="label text-white/85 text-[14px]">Срок</div>
              <div class="date text-[26px] font-extrabold mt-1">${days} дн</div>
            </div>
          </div>
          <div class=\"flip-hint\">Коснитесь для переворота</div>
        `;
        if (isV1) { /* chip removed by request */ }
        const back = document.createElement('div');
        back.className = 'face back bb-back px-5 py-5';
        back.innerHTML = `
          <div class="mag-stripe" aria-hidden="true"></div>
          <div class=\"flip-hint\">Коснитесь для переворота</div>
        `;
        const glare = document.createElement('div'); glare.className = 'glare-streak';
        rotor.appendChild(front); rotor.appendChild(back); rotor.appendChild(glare); cardWrapper.appendChild(rotor);
        // autoscale brand in Market simple slider
        try{ const brandEl = front.querySelector('.bb-logo'); autoscaleBrandEl(brandEl); }catch(_){ }
        // Apply gradient color mode for Market slider cards
        try{
          const mode=(CONFIG&&CONFIG.card_color_mode)||'random';
          const key = (mode==='by_tariff') ? (tariff.id||t.id||idx) : Math.random();
          const grad = (mode==='by_tariff') ? pickGradientByKey(key) : pickGradientRandom();
          front.style.background = grad; back.style.background = grad;
        }catch(_){ }
        const info = document.createElement('div');
        info.className = 'mt-3';
        info.innerHTML = `
          <style>
            .traffic{height:120px;border-radius:12px;background:linear-gradient(180deg,#151515,#0f0f10);border:1px solid rgba(255,255,255,0.03);padding:12px;margin-bottom:18px;color:var(--muted);font-size:13px;display:flex;flex-direction:column;justify-content:center}
            .traffic small{color:var(--muted);margin-bottom:8px}
            .traffic .chart{height:60px;border-radius:8px;background:#0b0b0b;border-top:2px solid rgba(20,115,255,0.7);display:flex;align-items:flex-end;padding:6px;color:transparent}
            .grid-info{display:grid;grid-template-columns:1fr 1fr;gap:12px}
            .grid-info .cell{border:1px solid rgba(255,255,255,0.06);background:#27272A;border-radius:12px;padding:10px}
          </style>
          <div class="grid-info" role="list">
            <div class="cell">
              <div style="font-size:12px;color:var(--muted);font-weight:600">Стоимость в месяц</div>
              <div style="font-size:20px;margin-top:6px">${price} ₽</div>
            </div>
            <div class="cell">
              <div style="font-size:12px;color:var(--muted);font-weight:600">Кол-во устройств</div>
              <div style="font-size:20px;margin-top:6px">${devs}</div>
            </div>
          </div>`;
        const buyBtn = document.createElement('button');
        buyBtn.className = 'tap rounded-xl bg-bluebtn text-white font-semibold py-2 w-full mt-2';
        buyBtn.textContent = `Купить за ${price} ₽`;
        buyBtn.onclick = async (e) => { e.preventDefault(); try { buyBtn.disabled = true; const old = buyBtn.textContent; buyBtn.textContent = '⏳'; const meR = await api('me'); if(!meR.ok) { alert('Ошибка получения баланса'); buyBtn.textContent = old; return; } const me = await meR.json(); const balance = me.balance || 0; if(balance >= price) { const r = await api('buy', {tariff_id: t.id}); if(r.ok) { const data = await r.json(); if(data.extended) { showToast('Подписка продлена'); } else { showToast('Подписка оформлена'); } setTimeout(() => location.reload(), 400); } else { const errorData = await r.json().catch(() => ({})); alert(errorData.detail || 'Ошибка покупки'); } } else { const needAmount = price - balance; const methodsR = await api('payments'); if(!methodsR.ok) { alert('Нет доступных методов оплаты'); buyBtn.textContent = old; return; } const methods = await methodsR.json(); if(!methods.items || methods.items.length === 0) { alert(`Недостаточно средств. Пополните баланс на ${needAmount} ₽`); buyBtn.textContent = old; return; } const method = methods.items[0]; const payR = await api('create_payment', { method: method.key, amount: needAmount, tariff_id: t.id }); if(payR.ok) { const payData = await payR.json(); if(payData.url) { window.LAST_BUY_TARIFF = { tariff_id: t.id, price: price }; showToast(`Переход к оплате ${needAmount} ₽`); startAutoRenewWatch(); setTimeout(() => { openExternal(payData.url); }, 100); } else { alert('Не получена ссылка на оплату'); } } else { alert(`Недостаточно средств. Пополните баланс на ${needAmount} ₽`); } } buyBtn.textContent = old; } finally { buyBtn.disabled = false; } };
        cardWrapper.addEventListener('click', (e) => { if(!e.target.closest('button') && !e.target.closest('a')) { haptic('selection'); cardWrapper.classList.toggle('flipped'); } });
        rotor.addEventListener('pointermove', (e) => { const r = rotor.getBoundingClientRect(); const xp = Math.max(0, Math.min(1, (e.clientX - r.left) / Math.max(1, r.width))); const yp = Math.max(0, Math.min(1, (e.clientY - r.top) / Math.max(1, r.height))); rotor.style.setProperty('--streak-pos', (xp*100)+'% '+(yp*100)+'%'); front.style.setProperty('--sx', (xp*100)+'%'); front.style.setProperty('--sy', (yp*100)+'%'); });
        window.addEventListener('deviceorientation', (e) => { try { const xRatio = clamp((e.gamma||0)/8, -1, 1); const yRatio = clamp(((e.beta||0)-45)/8, -1, 1); const xp = 0.5 + xRatio*0.5; const yp = 0.5 + yRatio*0.5; rotor.style.setProperty('--streak-pos', (xp*100)+'% '+(yp*100)+'%'); front.style.setProperty('--sx', (xp*100)+'%'); front.style.setProperty('--sy', (yp*100)+'%'); } catch(_) {} }, { passive: true });
        window.addEventListener('devicemotion', (e) => { try { const g=e.accelerationIncludingGravity||{}; const gx=g.x||0, gy=g.y||0; const xp = 0.5 + clamp(gx/9.8, -1, 1)*0.5; const yp = 0.5 + clamp(-gy/9.8, -1, 1)*0.5; rotor.style.setProperty('--streak-pos', (xp*100)+'% '+(yp*100)+'%'); front.style.setProperty('--sx', (xp*100)+'%'); front.style.setProperty('--sy', (yp*100)+'%'); } catch(_) {} }, { passive: true });
        // no back button anymore
        slide.appendChild(cardWrapper); slide.appendChild(info); slide.appendChild(buyBtn); slides.appendChild(slide);
      });
      grid.appendChild(slides);
      function selectTabById(tid){ 
        tabs.querySelectorAll('button').forEach(b=>{ 
          const isActive = (b.dataset.tid===String(tid));
          b.classList.toggle('active', isActive);
          b.classList.toggle('bg-[#1a2230]', isActive);
          b.classList.toggle('border', isActive);
          b.classList.toggle('border-[#2a3547]', isActive);
          b.classList.toggle('text-white', isActive);
          b.classList.toggle('text-[#9aa4b2]', !isActive);
          b.classList.toggle('border-transparent', !isActive);
        }); 
      }
      tabs.querySelectorAll('button').forEach(b=>{ b.onclick=()=>{ const tid=b.dataset.tid; const el=slides.querySelector('[data-tid=\''+tid+'\']'); if(el){ el.scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'}); selectTabById(tid); } }; });
      slides.addEventListener('scroll', ()=>{ const children=[...slides.children]; let best=children[0]; let bestDist=1e9; const cx=slides.scrollLeft + slides.clientWidth/2; children.forEach(ch=>{ const rect=ch.getBoundingClientRect(); const dist=Math.abs((rect.left+rect.width/2) - (slides.getBoundingClientRect().left+slides.clientWidth/2)); if(dist<bestDist){ bestDist=dist; best=ch; } }); if(best){ selectTabById(best.dataset.tid); } });
      if(names.length){ selectTabById(names[0].id); }
    }
    function tierForPrice(p){ if(p<100) return 'basic'; if(p<250) return p<200?'mid':'mid2'; return 'vip'; }
    function cardClassForTier(t){ if(t==='vip') return 'tier-vip'; if(t==='mid2') return 'tier-mid2'; if(t==='mid') return 'tier-mid'; return 'cc-bg'; }
    function cardClassByIndex(idx){ if(idx === 0) return 'tier-1'; if(idx === 1) return 'tier-2'; if(idx === 2) return 'tier-3'; return 'tier-' + ((idx % 3) + 1); }

    // Модальное окно продления
    function showExtendModal(clientId) { const modal = document.getElementById('extendModal'); const tariffsBox = document.getElementById('extendTariffs'); if (!modal || !tariffsBox) return; tariffsBox.innerHTML = ''; 
      // group tariffs by subgroup_title if present
      const hasSub = (TARIFFS||[]).some(t => (t.subgroup_title||'').trim().length>0);
      if(hasSub){
        const bySub = {};
        (TARIFFS||[]).forEach(t=>{ const k=(t.subgroup_title||'').trim()||'Другое'; (bySub[k]||(bySub[k]=[])).push(t); });
        Object.keys(bySub).forEach(sub=>{
          const header=document.createElement('div'); header.className='text-xs text-slate-400 mt-2 mb-1 px-1'; header.textContent=sub; tariffsBox.appendChild(header);
          bySub[sub].forEach((tariff)=>{
            const price = tariff.price_rub || 0; const days = tariff.duration_days || 30;
            const item=document.createElement('div'); item.className='tap rounded-xl bg-[#27272A] border border-[#3A3A3D] p-3 hover:bg-[#303035] transition-colors cursor-pointer flex items-center justify-between text-white';
            item.innerHTML = `<div><div class=\"font-semibold text-white\">${tariff.name || 'Тариф'}</div><div class=\"text-sm text-slate-400\">${days} дней</div></div><div class=\"text-right\"><div class=\"text-lg font-bold text-white\">${price} ₽</div></div>`;
            item.onclick = async () => { if (item.dataset.processing === 'true') return; item.dataset.processing = 'true'; const oldHtml = item.innerHTML; item.innerHTML = '<div class="text-center">⏳ Обработка...</div>'; try { const r = await api('extend', { client_id: clientId, tariff_id: tariff.id }); if (r.ok) { showToast('Подписка продлена'); setTimeout(() => location.reload(), 400); } else if (r.status === 402) { const data = await r.json(); const needAmount = data.need_amount || 0; const balance = data.balance || 0; if (confirm(`На балансе: ${balance}₽\nНе хватает: ${needAmount}₽\n\nПерейти к оплате?`)) { const methodsR = await api('payments'); if (!methodsR.ok) { alert('Нет доступных методов оплаты'); item.innerHTML = oldHtml; item.dataset.processing = 'false'; return; } const methods = await methodsR.json(); if (!methods.items || methods.items.length === 0) { alert(`Недостаточно средств. Пополните баланс на ${needAmount}₽`); item.innerHTML = oldHtml; item.dataset.processing = 'false'; return; } const method = methods.items[0]; const payAmount = needAmount < 10 ? 10 : needAmount; const payR = await api('create_payment', { method: method.key, amount: payAmount, client_id: clientId, tariff_id: tariff.id }); if (payR.ok) { const payData = await payR.json(); if (payData.url) { window.LAST_EXTEND = { client_id: clientId, tariff_id: tariff.id }; showToast(`Переход к оплате ${payAmount}₽`); startAutoRenewWatch(); setTimeout(() => { openExternal(payData.url); }, 100); } else { alert('Не получена ссылка на оплату'); } } else { alert(`Ошибка создания платежа`); } } item.innerHTML = oldHtml; item.dataset.processing = 'false'; } else { const errorData = await r.json().catch(() => ({})); alert(errorData.detail || 'Ошибка продления'); item.innerHTML = oldHtml; item.dataset.processing = 'false'; } } catch (error) { console.error('Ошибка продления:', error); alert('Ошибка продления подписки'); item.innerHTML = oldHtml; item.dataset.processing = 'false'; } };
            tariffsBox.appendChild(item);
          });
        });
      } else {
        (TARIFFS||[]).forEach((tariff, idx) => {
          const price = tariff.price_rub || 0; const days = tariff.duration_days || 30;
          const item=document.createElement('div'); item.className='tap rounded-xl bg-[#27272A] border border-[#3A3A3D] p-3 hover:bg-[#303035] transition-colors cursor-pointer flex items-center justify-between text-white';
          item.innerHTML = `<div><div class=\"font-semibold text-white\">${tariff.name || 'Тариф'}</div><div class=\"text-sm text-slate-400\">${days} дней</div></div><div class=\"text-right\"><div class=\"text-lg font-bold text-white\">${price} ₽</div></div>`;
          item.onclick = async () => { if (item.dataset.processing === 'true') return; item.dataset.processing = 'true'; const oldHtml = item.innerHTML; item.innerHTML = '<div class="text-center">⏳ Обработка...</div>'; try { const r = await api('extend', { client_id: clientId, tariff_id: tariff.id }); if (r.ok) { showToast('Подписка продлена'); setTimeout(() => location.reload(), 400); } else if (r.status === 402) { const data = await r.json(); const needAmount = data.need_amount || 0; const balance = data.balance || 0; if (confirm(`На балансе: ${balance}₽\nНе хватает: ${needAmount}₽\n\nПерейти к оплате?`)) { const methodsR = await api('payments'); if (!methodsR.ok) { alert('Нет доступных методов оплаты'); item.innerHTML = oldHtml; item.dataset.processing = 'false'; return; } const methods = await methodsR.json(); if (!methods.items || methods.items.length === 0) { alert(`Недостаточно средств. Пополните баланс на ${needAmount}₽`); item.innerHTML = oldHtml; item.dataset.processing = 'false'; return; } const method = methods.items[0]; const payAmount = needAmount < 10 ? 10 : needAmount; const payR = await api('create_payment', { method: method.key, amount: payAmount, client_id: clientId, tariff_id: tariff.id }); if (payR.ok) { const payData = await payR.json(); if (payData.url) { window.LAST_EXTEND = { client_id: clientId, tariff_id: tariff.id }; showToast(`Переход к оплате ${payAmount}₽`); startAutoRenewWatch(); setTimeout(() => { openExternal(payData.url); }, 100); } else { alert('Не получена ссылка на оплату'); } } else { alert(`Ошибка создания платежа`); } } item.innerHTML = oldHtml; item.dataset.processing = 'false'; } else { const errorData = await r.json().catch(() => ({})); alert(errorData.detail || 'Ошибка продления'); item.innerHTML = oldHtml; item.dataset.processing = 'false'; } } catch (error) { console.error('Ошибка продления:', error); alert('Ошибка продления подписки'); item.innerHTML = oldHtml; item.dataset.processing = 'false'; } };
          tariffsBox.appendChild(item);
        });
      }
      modal.classList.remove('hidden'); }
    function hideExtendModal() { const modal = document.getElementById('extendModal'); if (modal) modal.classList.add('hidden'); }
    document.addEventListener('DOMContentLoaded', () => { const modal = document.getElementById('extendModal'); const closeBtn = document.getElementById('closeExtend'); if (closeBtn) { closeBtn.onclick = ()=>{ haptic('selection'); hideExtendModal(); }; } if (modal) { modal.addEventListener('click', (e) => { if (e.target === modal) hideExtendModal(); }); } });

    function renderAllSubscriptions(subs, me) {
      me = (me && (me.username || me.first_name)) ? me : (ME || {});
      const container = document.getElementById('vpnCardsContainer') || document.querySelector('#page_vpn');
      if (!container) return;
      if (container.id === 'vpnCardsContainer') { container.innerHTML = ''; }
      // Prepare container as horizontal slider when multiple subs
      if (container.id === 'vpnCardsContainer'){
        container.classList.add('flex','overflow-x-auto','snap-x','snap-mandatory','gap-3','pb-2','px-4');
        container.style.scrollSnapType = 'x mandatory';
        container.style.webkitOverflowScrolling = 'touch';
        container.style.scrollbarWidth = 'none';
        container.style.msOverflowStyle = 'none';
      }
      if (!subs || subs.length === 0) {
        const placeholder = `
          <section id="noSubSection" class="mx-4 mb-4">
            <div id="noSubWrap" class="w-full flex items-center justify-center" style="min-height:60vh">
              <div class="bg-[#27272A] rounded-2xl shadow-md border border-[#3A3A3D] px-4 py-4 max-w-md w-full text-center">
                <img src="https://speedupnet.vip/gif.gif" alt="no-sub" class="mx-auto w-[260px] h-[220px] object-contain rounded-xl opacity-90 select-none"/>
                <div class="mt-3 text-white text-base">Похоже, у вас нет подписки</div>
                <button id="goMarketBtn" class="tap inline-flex items-center justify-center gap-2 mt-3 px-4 py-2 rounded-xl bg-bluebtn text-white font-semibold">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4"><path d="M7 4h10l1 3h3v2h-1l-2 9H7L5 9H4V7h3l1-3zm3 3h4l-.5-1.5h-3L10 7z"/></svg>
                  Магазин
                </button>
              </div>
            </div>
          </section>`;
        if (container.id !== 'vpnCardsContainer') { const existingCard = document.getElementById('subCard'); if (existingCard) { existingCard.outerHTML = placeholder; } else { container.insertAdjacentHTML('afterbegin', placeholder); } } else { container.innerHTML = placeholder; }
        const segWrap=document.getElementById('vpnSegWrap');
        const seg=document.getElementById('vpnSegment'); const info=document.getElementById('vpnInfo'); const avail=document.getElementById('vpnAvailability');
        if(segWrap){ segWrap.classList.add('hidden'); }
        if(seg){ seg.classList.add('hidden'); }
        if(info){ info.classList.add('hidden'); }
        if(avail){ avail.classList.add('hidden'); }
        const btn = document.getElementById('goMarketBtn'); if(btn){ btn.onclick = ()=>{ setActiveNav('nav_market'); }; }
        return;
      }
      subs.forEach((sub, index) => {
        const name = sub.tariff_name || 'Тариф';
        const expiryDate = fmtDateNoYear((sub.expiry_time || 0) / 1000);
        const cardId = `subCard_${index}`;
        const ownerName = computeOwnerName();
        const mode=(CONFIG&&CONFIG.card_color_mode)||'random';
        const paletteKey = (mode==='by_tariff') ? (sub.tariff_id || sub.client_id || index) : Math.random();
        const palette = (mode==='by_tariff') ? pickPaletteByKey(paletteKey) : pickPaletteRandom();
        const brandTxt = (CONFIG && (CONFIG.brand_name||CONFIG.mini_title)) || 'VPN';
        const link = (sub.sub_url||sub.link||sub.remnawave_link)||'';
        const cardHtml = `
          <div class="sub-slide snap-center shrink-0 w-full max-w-md transition-transform" style="transform:scale(1);">
            <section id="${cardId}" class="card-3d mb-2">
              <div class="card-rotor border border-white/15 rounded-[20px] shadow-xl">
                <div class="face front bb-front px-5 py-5">
                  <div class="bb-header">
                    <div class="card-label text-sm">${name}</div>
                    <div class="bb-logo" style="transform-origin:top right; margin-right:12px;">${brandTxt}</div>
                  </div>
                  <div class="bb-bottom">
                    <div class="bb-owner-info">
                      <div class="bb-owner-label">Владелец</div>
                      <div class="bb-owner-name owner-name-text">${ownerName}</div>
                    </div>
                    <div class="bb-expiry-info">
                      <div class="bb-expiry-label">Заканчивается</div>
                      <div class="bb-expiry-date">${expiryDate}</div>
                    </div>
                  </div>
                  <div class="flip-hint">Коснитесь для переворота</div>
                </div>
                <div class="face back bb-back px-5 py-5">
                  <div class="mag-stripe" aria-hidden="true">
                    <a href="${link||'#'}" target="_blank" rel="noopener" class="flex-1 text-white/70 text-[11px] font-mono tracking-tight whitespace-nowrap overflow-hidden text-ellipsis text-center px-2" style="direction:ltr"><span>${link||'—'}</span></a>
                    <button class="tap rounded bg-white/10 hover:bg-white/20 text-white/70 w-7 h-7 flex items-center justify-center transition-colors flex-shrink-0 copy-btn" data-link="${link}" aria-label="Копировать">
                      <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" fill=\"currentColor\" class=\"w-4 h-4\"><path d=\"M16 1H6a2 2 0 00-2 2v10h2V3h10V1zm3 4H10a2 2 0 00-2 2v12a2 2 0 002 2h9a2 2 0 002-2V7a2 2 0 00-2-2zm0 14H10V7h9v12z\"/></svg>
                    </button>
                  </div>
                  <div class="flip-hint">Коснитесь для переворота</div>
                </div>
                <div class="glare-streak" aria-hidden="true"></div>
              </div>
              <div class="mx-1 mt-2 flex gap-2">
                <button class="tap flex-1 rounded-xl bg-green-600 hover:bg-green-700 text-white font-semibold py-2 extend-btn" data-client-id="${sub.client_id}">Продлить подписку</button>
              </div>
            </section>
          </div>`;
        if (container.id === 'vpnCardsContainer') { container.insertAdjacentHTML('beforeend', cardHtml); } else if (index === 0) { const existingCard = document.getElementById('subCard'); if (existingCard) { existingCard.outerHTML = cardHtml; } }
        setTimeout(() => {
          const card = document.getElementById(cardId);
          if (!card) return;
          const rotor = card.querySelector('.card-rotor');
          try{ const brandEl = card.querySelector('.bb-logo'); autoscaleBrandEl(brandEl); }catch(_){ }
          // flip handlers
          card.addEventListener('click', (e)=>{ if(!e.target.closest('button') && !e.target.closest('a')) { try{ haptic('medium'); }catch(_){ } card.classList.toggle('flipped'); } });
          // apply gradient by settings mode
          try{
            const front = card.querySelector('.face.front');
            const back = card.querySelector('.face.back');
            const mode=(CONFIG&&CONFIG.card_color_mode)||'random';
            const key = (mode==='by_tariff') ? (sub.tariff_id || sub.client_id || index) : Math.random();
            const grad = (mode==='by_tariff') ? pickGradientByKey(key) : pickGradientRandom();
            if(front) front.style.background = grad; if(back) back.style.background = grad;
          }catch(_){ }
          rotor && rotor.addEventListener('pointermove', (e)=>{ const r=rotor.getBoundingClientRect(); const xp=Math.max(0,Math.min(1,(e.clientX-r.left)/Math.max(1,r.width))); const yp=Math.max(0,Math.min(1,(e.clientY-r.top)/Math.max(1,r.height))); rotor.style.setProperty('--streak-pos',(xp*100)+'% '+(yp*100)+'%'); });
          window.addEventListener('deviceorientation', (e) => { try { if(!rotor) return; const xRatio = clamp((e.gamma||0)/8, -1, 1); const yRatio = clamp(((e.beta||0)-45)/8, -1, 1); const xp = 0.5 + xRatio*0.5; const yp = 0.5 + yRatio*0.5; rotor.style.setProperty('--streak-pos', (xp*100)+'% '+(yp*100)+'%'); } catch(_) {} }, { passive: true });
          window.addEventListener('devicemotion', (e) => { try { if(!rotor) return; const g=e.accelerationIncludingGravity||{}; const gx=g.x||0, gy=g.y||0; const xp = 0.5 + clamp(gx/9.8, -1, 1)*0.5; const yp = 0.5 + clamp(-gy/9.8, -1, 1)*0.5; rotor.style.setProperty('--streak-pos', (xp*100)+'% '+(yp*100)+'%'); } catch(_) {} }, { passive: true });
          // copy handler
          const copyBtn = card.querySelector('.copy-btn'); if(copyBtn){ copyBtn.onclick = async (e)=>{ e.preventDefault(); e.stopPropagation(); const l=copyBtn.getAttribute('data-link')||''; if(!l){ alert('Ссылка недоступна'); return; } try{ await navigator.clipboard.writeText(l); showToast('Скопировано'); }catch(_){} } }
        }, 100);
      });
      // If multiple subscriptions, show selection hint and update CURRENT_SUB by scroll position
      try{
        if(subs.length>1){
          const hintId='subSelectHint';
          if(!document.getElementById(hintId)){
            const h=document.createElement('div'); h.id=hintId; h.className='mx-4 mb-2 text-xs'; h.textContent='Выберите подписку для управления (листайте карточки)';
            const vpnTop=document.getElementById('vpnCardsContainer'); if(vpnTop){ vpnTop.parentElement.insertBefore(h, vpnTop); }
          }
          const cont=document.getElementById('vpnCardsContainer');
          const slides=[...cont.querySelectorAll('.sub-slide')];
          const updateSel=()=>{
            let bestIdx=0, bestD=1e9; const cx=cont.scrollLeft + cont.clientWidth/2; slides.forEach((ch, idx)=>{ const r=ch.getBoundingClientRect(); const d=Math.abs((r.left+r.width/2) - (cont.getBoundingClientRect().left+cont.clientWidth/2)); if(d<bestD){ bestD=d; bestIdx=idx; } ch.style.transition='transform .25s ease'; ch.style.transform='scale(1)'; ch.style.boxShadow='none'; });
            const active=slides[bestIdx]; if(active){ active.style.transform='scale(1.03)'; }
            const s=subs[bestIdx]; if(s){ CURRENT_SUB = s; try{ renderTrafficChart(); }catch(_){ } }
            syncOwnerNameToCards();
            try{ const hd=document.getElementById('owner_name'); if(hd){ hd.textContent = OWNER_NAME || computeOwnerName(); } }catch(_){ }
          };
          let selTimer=null; cont.addEventListener('scroll', ()=>{ if(selTimer) clearTimeout(selTimer); selTimer=setTimeout(()=>{ updateSel(); }, 120); }, { passive:true });
          setTimeout(updateSel, 150);
          // Desktop arrows
          try{ if(window.matchMedia && window.matchMedia('(pointer:fine)').matches){
            const navId='subsNav'; if(!document.getElementById(navId)){
              const nav=document.createElement('div'); nav.id=navId; nav.className='mx-4 mt-1 mb-2 flex items-center justify-between';
              const prev=document.createElement('button'); prev.className='tap rounded-xl btn-ghost px-3 py-1 text-sm'; prev.textContent='◀';
              const next=document.createElement('button'); next.className='tap rounded-xl btn-ghost px-3 py-1 text-sm'; next.textContent='▶';
              prev.onclick=()=>{ const slides=[...cont.querySelectorAll('.sub-slide')]; let best=0, bestD=1e9; slides.forEach((ch,idx)=>{ const r=ch.getBoundingClientRect(); const d=Math.abs((r.left+r.width/2) - (cont.getBoundingClientRect().left+cont.clientWidth/2)); if(d<bestD){ bestD=d; best=idx; } }); const target=Math.max(0, best-1); slides[target]?.scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'}); setTimeout(updateSel, 250); };
              next.onclick=()=>{ const slides=[...cont.querySelectorAll('.sub-slide')]; let best=0, bestD=1e9; slides.forEach((ch,idx)=>{ const r=ch.getBoundingClientRect(); const d=Math.abs((r.left+r.width/2) - (cont.getBoundingClientRect().left+cont.clientWidth/2)); if(d<bestD){ bestD=d; best=idx; } }); const target=Math.min(slides.length-1, best+1); slides[target]?.scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'}); setTimeout(updateSel, 250); };
              nav.appendChild(prev); nav.appendChild(next);
              cont.parentElement.insertBefore(nav, cont.nextSibling);
            }
          } }catch(_){ }
        }
      }catch(_){ }
    }
    function mountTariffsGrid(group){ const grid=document.getElementById('marketGrid'); if(!grid) return; const f=(TARIFFS||[]).filter(t=> (group==='Все') || ((t.group_code||'')===group) ); grid.innerHTML=''; f.forEach((t, idx)=>{ const price=(t.price_rub||0); const tier=tierForPrice(price); const cls=cardClassForTier(tier); const titleCls = tier==='vip' ? 'text-white drop-shadow' : (tier==='mid'||tier==='mid2') ? 'text-white' : 'text-slate-200'; const metaCls = tier==='basic' ? 'text-slate-400' : 'text-slate-200'; const cardWrapper = document.createElement('div'); cardWrapper.className = 'card-3d'; cardWrapper.id = `market-card-${idx}`; const rotor = document.createElement('div'); rotor.className = 'card-rotor rounded-2xl'; rotor.style.height = '200px'; const grad = randomGradient(); const front = document.createElement('div'); front.className = `face front px-4 py-4 ${cls}`; front.style.background = grad; front.innerHTML = `<div class=\"flex items-center justify-between mb-2\"><div class=\"text-sm font-semibold ${titleCls}\">${t.name||'Тариф'}</div><div class=\"text-sm text-white/80\">${(t.duration_days||0)} дн</div></div><div class=\"text-2xl font-extrabold text-white mb-3\">${price} ₽</div><div class=\"text-[11px] text-white/70\">Трафик: ${(t.traffic_limit!=null)?t.traffic_limit+' ГБ':'∞'}<br>Устройства: ${(t.device_limit!=null)?t.device_limit:'∞'}</div><div class=\"mt-auto text-[10px] text-white/50\">Нажмите для деталей</div>`; const back = document.createElement('div'); back.className = 'face back'; back.style.background = grad; back.innerHTML = `<div class=\"mag-stripe\"><span class=\"text-white/70 text-[10px] font-mono\">TARIFF-${t.id}-${price}RUB</span></div><div class=\"px-4 py-3 flex flex-col flex-1 justify-end\"><div class=\"text-white/90 text-sm mb-3\">${t.description || 'Премиум подписка'}</div><button class=\"tap rounded-xl bg-bluebtn text-white font-semibold py-2 w-full\" data-tid=\"${t.id}\">Купить за ${price} ₽</button></div>`; const glare = document.createElement('div'); glare.className = 'glare-streak'; rotor.appendChild(front); rotor.appendChild(back); rotor.appendChild(glare); cardWrapper.appendChild(rotor); grid.appendChild(cardWrapper); cardWrapper.addEventListener('click', (e) => { if(!e.target.closest('button')) { cardWrapper.classList.toggle('flipped'); } }); rotor.addEventListener('pointermove', (e) => { const r = rotor.getBoundingClientRect(); const xp = Math.max(0, Math.min(1, (e.clientX - r.left) / Math.max(1, r.width))); const yp = Math.max(0, Math.min(1, (e.clientY - r.top) / Math.max(1, r.height))); rotor.style.setProperty('--streak-pos', (xp*100)+'% '+(yp*100)+'%'); }); window.addEventListener('deviceorientation', (e) => { try { const xRatio = clamp((e.gamma||0)/8, -1, 1); const yRatio = clamp(((e.beta||0)-45)/8, -1, 1); const xp = 0.5 + xRatio*0.5; const yp = 0.5 + yRatio*0.5; rotor.style.setProperty('--streak-pos', (xp*100)+'% '+(yp*100)+'%'); } catch(_) {} }, { passive: true }); window.addEventListener('devicemotion', (e) => { try { const g=e.accelerationIncludingGravity||{}; const gx=g.x||0, gy=g.y||0; const xp = 0.5 + clamp(gx/9.8, -1, 1)*0.5; const yp = 0.5 + clamp(-gy/9.8, -1, 1)*0.5; rotor.style.setProperty('--streak-pos', (xp*100)+'% '+(yp*100)+'%'); } catch(_) {} }, { passive: true }); }); grid.querySelectorAll('button[data-tid]').forEach(btn=>{ btn.onclick=async(e)=>{ e.preventDefault(); e.stopPropagation(); const tid=parseInt(btn.getAttribute('data-tid')||'0',10); if(!tid) return; btn.disabled=true; const old=btn.textContent; btn.textContent='⏳'; try{ const r=await api('buy',{tariff_id:tid}); if(r.ok){ const data = await r.json(); try{ tg&&tg.HapticFeedback&&tg.HapticFeedback.notificationOccurred('success'); }catch(_){ } if(data.extended) { showToast('Подписка продлена'); } else { showToast('Подписка оформлена'); } location.hash='#'; setTimeout(()=>location.reload(), 500); } else { const d=await r.json().catch(()=>({detail:'Ошибка'})); alert(d.detail||'Ошибка'); } } finally{ btn.disabled=false; btn.textContent=old; } }; }); }

    function renderPayments(items){ const box=document.getElementById('txList'); if(!box) return; if(!Array.isArray(items)||!items.length){ box.innerHTML='<div class="text-slate-500">Нет операций</div>'; return; } box.innerHTML=''; const MAX=20; (items.slice(0,MAX)).forEach(p=>{ const dt = new Date((p.created_at||0)*1000); const hh=String(dt.getHours()).padStart(2,'0'); const mm=String(dt.getMinutes()).padStart(2,'0'); const dd=String(dt.getDate()).padStart(2,'0'); const mo=String(dt.getMonth()+1).padStart(2,'0'); const isTopUp = (p.payment_system && p.payment_system !== 'balance'); const sign = isTopUp ? '+' : '-'; const color = isTopUp ? 'text-green-400' : 'text-red-400'; const icon = isTopUp ? '💳' : '🧾'; const label = isTopUp ? 'Пополнение' : 'Оплата тарифа'; const amt = (p.amount||0); const row=document.createElement('div'); row.className='flex items-center'; row.innerHTML=`<span class="text-xl mr-2">${icon}</span><span class="flex-grow text-white text-sm">${label} • ${dd}.${mo} ${hh}:${mm}</span><span class="font-bold ${color} text-sm">${sign} ${amt}₽</span>`; box.appendChild(row); }); if(items.length>MAX){ const more=document.createElement('div'); more.className='text-center text-xs text-slate-400 mt-1'; more.textContent=`Показано ${MAX} из ${items.length}`; box.appendChild(more); } }
    function renderRefs(items){ const box=document.getElementById('refList'); if(!box) return; if(!Array.isArray(items)||!items.length){ box.innerHTML='<div class="text-slate-500">Нет данных</div>'; return; } box.innerHTML=''; items.forEach(r=>{ const row=document.createElement('a'); row.href = r.username ? ('https://t.me/'+r.username) : ('https://t.me/user?id='+String(r.tg_id||'')); row.target='_blank'; row.rel='noopener'; row.className='flex items-center justify-between text-sm rounded-lg px-2 py-2 hover:bg-white/5 transition'; const name = r.username ? ('@'+r.username) : ('ID '+(r.tg_id||'')); const badge = r.reward_issued?'<span class="text-emerald-400">бонус</span>':'<span class="text-slate-400">без бонуса</span>'; row.innerHTML=`<span class="text-slate-200">${name}</span>${badge}`; box.appendChild(row); }); }

    async function main(){ try{
      const m = document.getElementById('topupModal'); const payBox=document.getElementById('payMethods'); const amt=document.getElementById('topupAmount'); const inc=document.getElementById('incAmount'); const dec=document.getElementById('decAmount'); if(inc){ inc.addEventListener('click', ()=>{ haptic('selection'); const step=parseInt(amt.step||'10',10)||10; const cur=parseInt(amt.value||'0',10)||0; amt.value=String(cur+step); }); } if(dec){ dec.addEventListener('click', ()=>{ haptic('selection'); const step=parseInt(amt.step||'10',10)||10; const min=parseInt(amt.min||'0',10)||0; const cur=parseInt(amt.value||'0',10)||0; amt.value=String(Math.max(min, cur-step)); }); }
      function showTopup(){ m.classList.remove('hidden'); }
      function hideTopup(){ m.classList.add('hidden'); }
            document.getElementById('topupBtn')?.addEventListener('click', async()=>{ haptic('medium'); showTopup(); try{ const ms = await api('payments'); if(ms.ok){ const data = await ms.json(); payBox.innerHTML=''; (data.items||[]).forEach(it=>{ const b=document.createElement('button'); b.className='tap pay-btn font-semibold'; b.textContent=it.label; b.onclick=async()=>{ haptic('light'); const amount=parseInt(amt.value||'0',10)||0; if(amount<=0){ alert('Введите сумму'); return; } b.disabled=true; b.textContent = '⏳'; const r=await api('create_payment',{ method: it.key, amount: amount }); if(r.ok){ const jr=await r.json(); const url=jr.url; if(url){ showToast('Переход к оплате'); setTimeout(() => { openExternal(url); }, 100); } else { alert('Не получена ссылка на оплату'); } } else { alert('Ошибка создания платежа'); } b.disabled=false; b.textContent = it.label; }; payBox.appendChild(b); }); } }catch(_){ } });
      document.getElementById('closeTopup')?.addEventListener('click', ()=>{ haptic('selection'); hideTopup(); });
      m.addEventListener('click', (e)=>{ if(e.target===m) hideTopup(); });
      try{ const cR=await api('config'); if(cR.ok) CONFIG=await cR.json(); }catch(_){ }
      const brand=(CONFIG&& (CONFIG.brand_name||CONFIG.mini_title)) || 'VPN'; document.getElementById('brandTitle').textContent = brand; document.getElementById('wm_text').textContent = (brand||'VPN').toString().replace(/[^\wА-Яа-я]+/g,'').toUpperCase().slice(0,12);
      try{ if(tg && (tg.platform==='android' || tg.platform==='ios')){ tg.expand && tg.expand(); } }catch(_){ }
      const authed = await ensureAuth(); if(!authed){ return; }
      const meR = await api('me'); if(!meR.ok) return; const me = await meR.json(); ME = me; document.getElementById('balance_text').textContent = fmtMoney(me.balance||0); try{ if(me.username){ const url='https://t.me/i/userpic/320/'+me.username+'.jpg'; const img=document.getElementById('avatarImg'); if(img) img.src=url; } }catch(_){ } refreshOwnerName();
      const subsR = await api('subscription'); const subs = subsR.ok?await subsR.json():[]; const tariffsR = await api('tariffs'); TARIFFS = tariffsR.ok?await tariffsR.json():[]; 
      renderAllSubscriptions(subs, ME||me);
            CURRENT_SUB = subs && subs.length ? subs[0] : null;
      HAS_SUB = !!(subs && subs.length);
      try{ renderTrafficChart(); }catch(_){ }
      try{ scheduleMskMidnight(); }catch(_){ }
      try{ if(window && !window.__trafficRefreshTimer){ window.__trafficRefreshTimer = setInterval(()=>{ try{ if(HAS_SUB){ renderTrafficChart(); } }catch(_){ } }, 60000); } }catch(_){ }
      // toggle VPN segment visibility by subscription presence
      try{
        const segWrap=document.getElementById('vpnSegWrap');
        const seg=document.getElementById('vpnSegment'); const info=document.getElementById('vpnInfo'); const avail=document.getElementById('vpnAvailability');
        if(segWrap){ segWrap.classList.toggle('hidden', !HAS_SUB); }
        if(seg){ seg.classList.toggle('hidden', !HAS_SUB); }
        if(info){ info.classList.toggle('hidden', !HAS_SUB); }
        if(avail){ avail.classList.toggle('hidden', !HAS_SUB); }
      }catch(_){ }
 
      // Segment control handlers
      try{
        const seg=document.getElementById('vpnSegment'); const info=document.getElementById('vpnInfo'); const avail=document.getElementById('vpnAvailability');
        function setSeg(k){
          const btns=seg?.querySelectorAll('button');
          btns&&btns.forEach(b=>{
            const on=(b.dataset.seg===k);
            b.classList.toggle('bg-[#3F3F46]',on);
            b.classList.toggle('text-white',on);
            b.classList.toggle('text-[#9aa1ae]',!on);
            b.classList.toggle('shadow-[0_6px_10px_rgba(0,0,0,0.35),inset_0_0_0_1px_rgba(255,255,255,0.06)]',on);
          });
          // smooth fade between sections
          if(info && avail){
            const showInfo = (k==='info');
            const showAvail = (k==='availability');
            [info, avail].forEach(el=>{ el.classList.remove('hidden'); el.style.transition='opacity 200ms ease, transform 200ms ease'; });
            if(showInfo){
              avail.style.opacity='0';
              avail.style.transform='translateY(8px)';
              setTimeout(()=>{ avail.classList.add('hidden'); }, 180);
              info.classList.remove('hidden');
              requestAnimationFrame(()=>{ info.style.opacity='1'; info.style.transform='translateY(0)'; });
              // ensure traffic chart renders after layout
              setTimeout(()=>{ try{ renderTrafficChart(); }catch(_){ } }, 200);
            } else {
              info.style.opacity='0';
              info.style.transform='translateY(8px)';
              setTimeout(()=>{ info.classList.add('hidden'); }, 180);
              avail.classList.remove('hidden');
              requestAnimationFrame(()=>{ avail.style.opacity='1'; avail.style.transform='translateY(0)'; });
            }
          } else {
            info?.classList.toggle('hidden', k!=='info');
            avail?.classList.toggle('hidden', k!=='availability');
            if(k==='info') { try{ renderTrafficChart(); }catch(_){ } }
          }
        }
        seg?.addEventListener('click',(e)=>{ if(!HAS_SUB) return; const b=e.target.closest('button[data-seg]'); if(!b) return; setSeg(b.dataset.seg); });
        if(HAS_SUB) setSeg('info');
      }catch(_){ }
      const backCopy=document.getElementById('backCopyBtn'); if(backCopy){ backCopy.onclick=async()=>{ haptic('light'); const link = bestLink(CURRENT_SUB); if(!link){ alert('Ссылка недоступна'); return; } try{ await navigator.clipboard.writeText(link); showToast('Скопировано'); }catch(_){ } }; }
      const copyBtn=document.getElementById('copy_btn'); if(copyBtn){ copyBtn.onclick=async()=>{ haptic('light'); const link=bestLink(CURRENT_SUB); if(!link){ alert('Ссылка недоступна'); return; } try{ await navigator.clipboard.writeText(link); showToast('Скопировано'); }catch(_){ } }; }
      // Market view: Variant A with subgroups if present, otherwise simple grid
      mountMarketView();
      // Разрешения на сенсоры по первому взаимодействию (iOS Telegram)
      try{ document.addEventListener('pointerdown', ()=>{ try{ if(!motionAsked){ motionAsked=true; askMotion(); } }catch(_){ } }, { once:true, passive:true }); }catch(_){ }
      // Theme toggle sync
      try{
        const cb=document.getElementById('toggle--daynight');
        const apply=(isLight)=>{ const html=document.documentElement; if(isLight){ html.classList.add('light'); html.classList.remove('dark'); } else { html.classList.remove('light'); html.classList.add('dark'); } cb.checked=isLight; localStorage.setItem('mlk_theme', isLight?'light':'dark'); };
        const saved=localStorage.getItem('mlk_theme'); if(saved){ apply(saved==='light'); } else { apply(false); }
        cb?.addEventListener('change',()=>{ apply(cb.checked); setTimeout(renderTrafficChart, 50); });
      }catch(_){ }
      document.getElementById('themeToggle')?.addEventListener('click', ()=>{ document.documentElement.classList.toggle('dark'); });
      if(CONFIG){ const i=CONFIG; const g=document.getElementById('guide_btn'); if(g && i.instruction_url){ g.onclick=(e)=>{ e.preventDefault(); window.open(i.instruction_url,'_blank'); }; }
        const pl=document.getElementById('privacyLink'); if(pl && i.privacy_url){ pl.href=i.privacy_url; }
        const ol=document.getElementById('offerLink'); if(ol && i.offer_url){ ol.href=i.offer_url; }
        const sl=document.getElementById('supportLink'); if(sl){ const msg = encodeURIComponent('Здравствуйте! Мой TG ID '+(me.id||'')); sl.href = i.support_url? (i.support_url) : ('https://t.me/'+(i.bot_username||'')); sl.addEventListener('click', ()=>{ try{ window.Telegram?.WebApp?.openTelegramLink(sl.href+'?start='+msg); }catch(_){ } }); }
      }
      const importModal=document.getElementById('importModal'); const importApps=document.getElementById('importApps');
      const manageModal=document.getElementById('manageModal');
      const manageBtn=document.getElementById('manage_btn');
      function showManage(){ manageModal?.classList.remove('hidden'); }
      function hideManage(){ manageModal?.classList.add('hidden'); }
      manageBtn?.addEventListener('click', ()=>{ haptic('medium'); showManage(); const ttl=document.getElementById('manageTitle'); if(ttl){ const s=CURRENT_SUB; const name=(s&& (s.alias||s.email||s.client_id||'подписка')); ttl.textContent='Управление подпиской: '+name; } });
      document.getElementById('closeManage')?.addEventListener('click', ()=>{ haptic('selection'); hideManage(); });
      manageModal?.addEventListener('click', (e)=>{ if(e.target===manageModal) hideManage(); });
      // Toggle Devices button based on capabilities (Remnawave only)
      try{ const capR=await api('capabilities'); if(capR.ok){ const caps=await capR.json(); const devBtn=document.getElementById('btnDevices'); if(devBtn){ devBtn.classList.toggle('hidden', !caps.has_devices); } } }catch(_){ }
      document.getElementById('btnExtend')?.addEventListener('click', ()=>{ haptic('selection'); hideManage(); try{ showExtendModal(CURRENT_SUB?.client_id); }catch(_){ } });
      const devicesModal=document.getElementById('devicesModal'); const devicesBox=document.getElementById('devicesBox');
      function showDevices(){ devicesModal?.classList.remove('hidden'); }
      function hideDevices(){ devicesModal?.classList.add('hidden'); }
      document.getElementById('closeDevices')?.addEventListener('click', ()=>{ haptic('selection'); hideDevices(); });
      document.getElementById('resetDevices')?.addEventListener('click', async()=>{ haptic('heavy'); try{ const cid = CURRENT_SUB?.client_id; const r = await api('reset_devices', { client_id: cid }); if(r.ok){ const js=await r.json(); showToast(`Сброшено: ${js.deleted||0}`); // reload list
            try{ const rr=await api('devices'); if(rr.ok){ const d=await rr.json(); const items = d.items||[]; const rows = items.map((x,idx)=>{ const plat=[x.platform||'', x.os_version||''].filter(Boolean).join(' / '); const created=(x.created_at||'').toString().slice(0,19).replace('T',' '); const updated=(x.updated_at||'').toString().slice(0,19).replace('T',' '); return `<tr class=\"border-b border-[#3A3A3D]\"><td class=\"px-2 py-2 align-top text-slate-400 text-xs\">${idx+1}.</td><td class=\"px-2 py-2 align-top\"><div class=\"text-white text-sm font-semibold\">${x.hwid||'-'}</div><div class=\"text-xs text-slate-400 mt-1\">📱 Модель: <span class=\"text-slate-200\">${x.model||'—'}</span></div><div class=\"text-xs text-slate-400 mt-1\">🧠 Платформа: <span class=\"text-slate-200\">${plat||'—'}</span></div><div class=\"text-xs text-slate-400 mt-1\">🌐 User‑Agent: <span class=\"text-slate-200\">${(x.user_agent||'').toString().slice(0,200)}</span></div><div class=\"text-xs text-slate-400 mt-1\">🕓 Создано: <span class=\"text-slate-200\">${created||'—'}</span></div><div class=\"text-xs text-slate-400 mt-1\">🔄 Обновлено: <span class=\"text-slate-200\">${updated||'—'}</span></div></td></tr>`; }).join(''); devicesBox.innerHTML = `<div class=\"rounded-xl bg-[#27272A] border border-[#3A3A3D]\"><div class=\"overflow-hidden rounded-xl\"><table class=\"w-full text-left text-sm\"><thead><tr class=\"text-xs text-slate-400\"><th class=\"px-2 py-2\">#</th><th class=\"px-2 py-2\">Устройство</th></tr></thead><tbody>${rows}</tbody></table></div></div>`; } }catch(_){} } else { const d=await r.json().catch(()=>({detail:'Ошибка'})); alert(d.detail||'Ошибка'); } }catch(_){ alert('Ошибка запроса'); } });
      devicesModal?.addEventListener('click', (e)=>{ if(e.target===devicesModal) hideDevices(); });
      document.getElementById('btnDevices')?.addEventListener('click', async()=>{ haptic('light'); try{ const r=await api('devices', { client_id: (CURRENT_SUB&&CURRENT_SUB.client_id)||null }); if(r.ok){ const d=await r.json(); const items = d.items||[]; if(!items.length){ devicesBox.innerHTML = '<div class="text-slate-400 text-sm">Нет устройств</div>'; showDevices(); return; } const rows = items.map((x,idx)=>{
        const plat = [x.platform||'', x.os_version||''].filter(Boolean).join(' / ');
        const created = (x.created_at||'').toString().slice(0,19).replace('T',' ');
        const updated = (x.updated_at||'').toString().slice(0,19).replace('T',' ');
        return `<tr class=\"border-b border-[#3A3A3D]\"><td class=\"px-2 py-2 align-top text-slate-400 text-xs\">${idx+1}.</td><td class=\"px-2 py-2 align-top\"><div class=\"text-white text-sm font-semibold\">${x.hwid||'-'}</div><div class=\"text-xs text-slate-400 mt-1\">📱 Модель: <span class=\"text-slate-200\">${x.model||'—'}</span></div><div class=\"text-xs text-slate-400 mt-1\">🧠 Платформа: <span class=\"text-slate-200\">${plat||'—'}</span></div><div class=\"text-xs text-slate-400 mt-1\">🌐 User‑Agent: <span class=\"text-slate-200\">${(x.user_agent||'').toString().slice(0,200)}</span></div><div class=\"text-xs text-slate-400 mt-1\">🕓 Создано: <span class=\"text-slate-200\">${created||'—'}</span></div><div class=\"text-xs text-slate-400 mt-1\">🔄 Обновлено: <span class=\"text-slate-200\">${updated||'—'}</span></div></td></tr>`; }).join('');
        devicesBox.innerHTML = `<div class=\"rounded-xl bg-[#27272A] border border-[#3A3A3D]\"><div class=\"overflow-hidden rounded-xl\"><table class=\"w-full text-left text-sm\"><thead><tr class=\"text-xs text-slate-400\"><th class=\"px-2 py-2\">#</th><th class=\"px-2 py-2\">Устройство</th></tr></thead><tbody>${rows}</tbody></table></div></div>`; showDevices(); } else { alert('Не удалось получить устройства'); } }catch(_){ alert('Ошибка запроса'); } });
      document.getElementById('btnDeleteSub')?.addEventListener('click', async()=>{ haptic('heavy'); if(!confirm('Удалить подписку?')) return; try{ const cid=CURRENT_SUB?.client_id; if(!cid){ alert('Подписка не найдена'); return; } const r=await api('delete_subscription',{ client_id: cid }); if(r.ok){ showToast('Подписка удалена'); setTimeout(()=>location.reload(),400); } else { const d=await r.json().catch(()=>({detail:'Ошибка'})); alert(d.detail||'Ошибка удаления'); } }catch(_){ alert('Ошибка запроса'); } });
      document.getElementById('btnQr')?.addEventListener('click', async()=>{ haptic('selection'); try{ const link=bestLink(CURRENT_SUB); if(!link){ alert('Ссылка недоступна'); return; } try{ const qrUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=240x240&data='+encodeURIComponent(link); const qrModal=document.getElementById('qrModal'); const qrImg=document.getElementById('qrImg'); const closeQr=document.getElementById('closeQr'); if(qrImg){ qrImg.src = qrUrl; } if(qrModal){ qrModal.classList.remove('hidden'); const onClose=()=>{ qrModal.classList.add('hidden'); }; closeQr?.addEventListener('click', onClose, { once:true }); qrModal.addEventListener('click', (e)=>{ if(e.target===qrModal) onClose(); }, { once:true }); } }catch(_){ alert('Не удалось показать QR'); } }catch(_){ } });
      function showImport(){ importModal.classList.remove('hidden'); }
      function hideImport(){ importModal.classList.add('hidden'); }
      document.getElementById('import_btn')?.addEventListener('click', ()=>{ haptic('medium'); showImport(); importApps.innerHTML=''; const link=bestLink(CURRENT_SUB); if(!link){ importApps.innerHTML='<div class="text-slate-400 text-sm">Ссылка недоступна</div>'; return; } const i=CONFIG||{}; const apps=[ {k:'happ_ru',label:'Happ (RU Apple ID)',url:i.app_link_happ_ru},{k:'happ_int',label:'Happ (INT Apple ID)',url:i.app_link_happ_int},{k:'clash',label:'Clash Verge (ПК)',url:i.app_link_clash} ]; apps.forEach(app=>{ const b=document.createElement('a'); b.className='tap w-full modal-btn font-semibold text-center'; b.textContent=app.label; b.target='_blank'; b.rel='noopener'; if(app.k.startsWith('happ')){ b.href='happ://add/'+encodeURIComponent(link); } else { b.href=app.url||'#'; b.onclick=(e)=>{ if(!app.url){ e.preventDefault(); } }; } importApps.appendChild(b); }); });
      document.getElementById('closeImport')?.addEventListener('click', ()=>{ haptic('selection'); hideImport(); });
      importModal.addEventListener('click', (e)=>{ if(e.target===importModal) hideImport(); });
      try{ const pR=await api('payments_history'); if(pR.ok){ renderPayments(await pR.json()); } }catch(_){ }
      try{ const rR=await api('referrals'); if(rR.ok){ renderRefs(await rR.json()); } }catch(_){ }
      setActiveNav('nav_vpn');
    }catch(e){ console.error('MiniLK:', e); } }
    document.addEventListener('DOMContentLoaded', main);

    // Variant A: Subgroup tabs + per-group slider with info and colors
    function mountMarketView(){
      const wrap=document.getElementById('marketTabs'); const grid=document.getElementById('marketGrid'); if(!wrap||!grid) return;
      const EXCLUDE=new Set(['discounts','discounts_max','gifts','trial']);
      const all=(TARIFFS||[]).filter(t=>!EXCLUDE.has(String((t.group_code||'')).toLowerCase()));
      const hasSubgroups = all.some(t => (t.subgroup_title||'').trim().length>0);
      const groups={}; let keys=[];
      if(hasSubgroups){
        all.forEach(t=>{ const k=(t.subgroup_title||'').trim(); (groups[k]||(groups[k]=[])).push(t); });
        keys=Object.keys(groups);
      } else {
        // fallback: each tariff is its own tab by name
        all.forEach(t=>{ const k=String(t.name||('Тариф '+t.id)); (groups[k]||(groups[k]=[])).push(t); });
        keys=Object.keys(groups);
      }
      wrap.innerHTML=''; grid.innerHTML='';
      let activeKey = keys[0]||'';
      // Segment strip
      const segWrap=document.createElement('div'); segWrap.className='w-full px-4 flex justify-center'; segWrap.style.width='100vw'; segWrap.style.marginLeft='calc(50% - 50vw)'; segWrap.style.marginRight='calc(50% - 50vw)';
      const seg=document.createElement('div'); seg.id='marketSegment'; seg.className='segment flex justify-center gap-2 bg-[#27272A] rounded-[14px] px-2 py-1 shadow-[inset_0_0_0_1px_rgba(255,255,255,0.06)] overflow-x-auto no-scrollbar w-full'; seg.style.webkitOverflowScrolling='touch';
      keys.forEach((code,idx)=>{ const b=document.createElement('button'); b.className='tap px-3 py-2 rounded-[10px] font-semibold text-[13px] '+(idx===0?'text-white bg-[#3F3F46] shadow-[0_6px_10px_rgba(0,0,0,0.35),inset_0_0_0_1px_rgba(255,255,255,0.06)]':'text-[#9aa1ae]'); b.textContent=code||'Все'; b.dataset.gcode=code; b.onclick=()=>{ haptic('selection'); setSeg(code); }; seg.appendChild(b); });
      segWrap.appendChild(seg); wrap.appendChild(segWrap);
      // Slides viewport for slide animation
      const viewport=document.createElement('div'); viewport.className='relative overflow-hidden';
      const track=document.createElement('div'); track.id='marketTrack'; track.className='flex transition-transform duration-250 ease-out';
      viewport.appendChild(track); grid.appendChild(viewport);

      function setSeg(code){ if(!(code in groups)) return; activeKey=code; // update buttons
        [...seg.querySelectorAll('button')].forEach(b=>{ const on=(b.dataset.gcode===code); b.classList.toggle('text-white', on); b.classList.toggle('bg-[#3F3F46]', on); b.classList.toggle('shadow-[0_6px_10px_rgba(0,0,0,0.35),inset_0_0_0_1px_rgba(255,255,255,0.06)]', on); b.classList.toggle('text-[#9aa1ae]', !on); });
        const idx=keys.indexOf(code); const w=viewport.clientWidth||1; track.style.transition='transform 240ms cubic-bezier(.2,.8,.2,1)'; track.style.transform=`translateX(${-idx*w}px)`;
      }
      function goGroup(dir){ const idx=keys.indexOf(activeKey); const next=(idx+dir+keys.length)%keys.length; setSeg(keys[next]); }

      // Build slides for each key
      keys.forEach((code, slideIdx)=>{
        const slide=document.createElement('div'); slide.className='shrink-0 w-full px-0'; slide.style.width='100%';
        // Render group content into slide
        renderGroupInto(slide, code, groups[code]||[]);
        track.appendChild(slide);
      });

      function renderGroupInto(container, code, tariffs){ container.innerHTML=''; if(!tariffs.length){ container.innerHTML='<div class="text-slate-400 text-sm px-3 py-2">Нет тарифов</div>'; return; }
        const slides=document.createElement('div'); slides.className='flex overflow-x-auto snap-x snap-mandatory gap-3'; slides.setAttribute('data-role','tariffSlides'); container.classList.add('relative'); slides.style.scrollSnapType='x mandatory'; slides.style.webkitOverflowScrolling='touch'; slides.style.scrollbarWidth='none'; slides.style.msOverflowStyle='none'; slides.style.cssText += '::-webkit-scrollbar { display: none; }';
        const dots=document.createElement('div'); dots.className='flex justify-center gap-1 mt-1 mb-1';
        tariffs.forEach((t,idx)=>{
          const price=t.price_rub!=null?t.price_rub:0; const devs=t.device_limit!=null?t.device_limit:'∞'; const days=t.duration_days||30; const traf=(t.traffic_limit!=null)?(t.traffic_limit+' ГБ'):'∞';
          const slide=document.createElement('div'); slide.className='snap-center shrink-0 w-full'; slide.dataset.tid=String(t.id);
          const cardWrapper=document.createElement('div'); cardWrapper.className='card-3d mb-3'; cardWrapper.id=`market-card-${code||'all'}-${idx}`; cardWrapper.style.position='relative';
          const rotor=document.createElement('div'); rotor.className='card-rotor rounded-[20px]'; rotor.style.height='220px';
          const idxGlobal=(TARIFFS||[]).findIndex(x=>x.id===t.id); const cls=cardClassByIndex(idxGlobal>=0?idxGlobal:idx);
          const isV1=(cls==='tier-1'), isV2=(cls==='tier-2'), isV3=(cls==='tier-3');
          const front=document.createElement('div'); front.className = (isV1 ? 'face front px-5 py-5 card-v1-front' : isV2 ? 'face front px-5 py-5 card-v2-front' : isV3 ? 'face front px-5 py-5 card-v3-front' : `face front px-5 py-5 ${cls} cc-overlay`);
          const perDay = days>0 ? Math.round((price/days)*100)/100 : price;
          front.innerHTML = `<div class=\"brand absolute right-5 top-7 font-extrabold text-[44px] tracking-[2px] text-white/15 select-none\">VPN</div><div class=\"card-label text-sm\">${t.name||'Тариф'}</div><div class=\"flex justify-between items-end mt-auto pt-6\"><div><div class=\"label text-white/85 text-[14px]\">Стоимость</div><div class=\"value text-[22px] font-extrabold\">${price} ₽</div><div class=\"mt-1 price-pill\">≈ ${perDay} ₽/день</div></div><div class=\"exp text-right\"><div class=\"label text-white/85 text-[14px]\">Срок</div><div class=\"date text-[26px] font-extrabold mt-1\">${days} дн</div></div></div><div class=\"flip-hint\">Коснитесь для переворота</div>`;
          const back=document.createElement('div'); back.className='face back bb-back px-5 py-5'; back.innerHTML = `<div class=\"mag-stripe\" aria-hidden=\"true\"></div><div class=\"flip-hint\">Коснитесь для переворота</div>`;
          const glare=document.createElement('div'); glare.className='glare-streak';
          rotor.appendChild(front); rotor.appendChild(back); rotor.appendChild(glare); cardWrapper.appendChild(rotor);
          // Apply gradient color mode for Market grouped cards
          try{ const mode=(CONFIG&&CONFIG.card_color_mode)||'random'; const key=(mode==='by_tariff')?(t.id||idx):Math.random(); const grad=(mode==='by_tariff')?pickGradientByKey(key):pickGradientRandom(); front.style.background=grad; back.style.background=grad; }catch(_){ }
          // Flip interactions
          cardWrapper.addEventListener('click', (e)=>{ if(!e.target.closest('button')) { haptic('selection'); cardWrapper.classList.toggle('flipped'); } });
          rotor.addEventListener('pointermove', (e)=>{ const r=rotor.getBoundingClientRect(); const xp=Math.max(0,Math.min(1,(e.clientX-r.left)/Math.max(1,r.width))); const yp=Math.max(0,Math.min(1,(e.clientY-r.top)/Math.max(1,r.height))); rotor.style.setProperty('--streak-pos',(xp*100)+'% '+(yp*100)+'%'); });
          slide.appendChild(cardWrapper);
          const info=document.createElement('div'); info.className='mt-2'; info.innerHTML=`<div class=\"grid grid-cols-2 gap-2\"><div class=\"rounded-xl bg-[#27272A] p-3\"><div class=\"text-xs text-slate-400\">Трафик</div><div class=\"text-lg font-bold text-white\">${traf}</div></div><div class=\"rounded-xl bg-[#27272A] p-3\"><div class=\"text-xs text-slate-400\">Устройства</div><div class=\"text-lg font-bold text-white\">${devs}</div></div></div>`;
          const buyBtn=document.createElement('button'); buyBtn.className='tap rounded-xl bg-bluebtn text-white font-semibold py-2 w-full mt-2'; buyBtn.textContent=`Купить за ${price} ₽`;
          buyBtn.onclick=async(e)=>{ e.preventDefault(); try{ buyBtn.disabled=true; const old=buyBtn.textContent; buyBtn.textContent='⏳'; const meR=await api('me'); if(!meR.ok){ alert('Ошибка получения баланса'); buyBtn.textContent=old; return; } const me=await meR.json(); const balance=me.balance||0; if(balance>=price){ const r=await api('buy',{tariff_id:t.id}); if(r.ok){ const data=await r.json(); if(data.extended){ showToast('Подписка продлена'); } else { showToast('Подписка оформлена'); } setTimeout(()=>location.reload(),400); } else { const errorData=await r.json().catch(()=>({})); alert(errorData.detail||'Ошибка покупки'); } } else { const needAmount=price-balance; const methodsR=await api('payments'); if(!methodsR.ok){ alert('Нет доступных методов оплаты'); buyBtn.textContent=old; return; } const methods=await methodsR.json(); if(!methods.items||methods.items.length===0){ alert(`Недостаточно средств. Пополните баланс на ${needAmount} ₽`); buyBtn.textContent=old; return; } const method=methods.items[0]; const payR=await api('create_payment',{ method: method.key, amount: needAmount, tariff_id: t.id }); if(payR.ok){ const payData=await payR.json(); if(payData.url){ showToast(`Переход к оплате ${needAmount} ₽`); startAutoRenewWatch(); setTimeout(() => { openExternal(payData.url); }, 100); } else { alert('Не получена ссылка на оплату'); } } else { alert(`Недостаточно средств. Пополните баланс на ${needAmount} ₽`); } } buyBtn.textContent=old; } finally { buyBtn.disabled=false; } };
          slide.appendChild(info); slide.appendChild(buyBtn);
          slides.appendChild(slide);
          const dot=document.createElement('span'); dot.className='w-1.5 h-1.5 rounded-full bg-white/30 inline-block'; dots.appendChild(dot);
        });
                container.appendChild(slides); container.appendChild(dots);
        const updDots=()=>{ const children=[...slides.children]; let best=0; let bestDist=1e9; children.forEach((ch,i)=>{ const rect=ch.getBoundingClientRect(); const dist=Math.abs((rect.left+rect.width/2) - (slides.getBoundingClientRect().left+slides.clientWidth/2)); if(dist<bestDist){ bestDist=dist; best=i; } }); [...dots.children].forEach((d,i)=>{ d.classList.toggle('bg-white/80', i===best); d.classList.toggle('bg-white/30', i!==best); }); };
        slides.addEventListener('scroll', ()=>{ updDots(); }); setTimeout(updDots, 50);
        // Desktop navigation helpers: arrows + keyboard + wheel
        if (typeof window !== 'undefined'){
          const isDesktop = !(/android|iphone|ipad|ipod/i).test(navigator.userAgent||'');
          if(isDesktop){
            // overlay arrows
            const mkBtn=(dir)=>{ const b=document.createElement('button'); b.className='tap absolute top-1/2 -translate-y-1/2 w-9 h-9 rounded-full bg-black/35 hover:bg-black/55 text-white backdrop-blur-sm flex items-center justify-center transition'; b.innerHTML= dir<0 ? '&#10094;' : '&#10095;'; b.style.zIndex='10'; return b; };
            const prev=mkBtn(-1), next=mkBtn(1);
                      // place arrows centered over the card container
          container.appendChild(prev); container.appendChild(next);
          prev.style.left='8px'; prev.style.right='auto'; prev.style.top='50%'; prev.style.transform='translateY(-50%)';
          next.style.right='8px'; next.style.left='auto'; next.style.top='50%'; next.style.transform='translateY(-50%)';
            const scrollByCard=(d)=>{ const ch=[...slides.children]; if(!ch.length) return; const cardW=ch[0].getBoundingClientRect().width || slides.clientWidth; slides.style.scrollBehavior='smooth'; slides.scrollBy({ left: d*cardW }); };
            const go=(dir)=>{ if(hasSubgroups && (tariffs.length>1)){ scrollByCard(dir); } else { const idx=keys.indexOf(activeKey); const next=(idx+dir+keys.length)%keys.length; setSeg(keys[next]); } };
            prev.onclick=()=>{ haptic('selection'); go(-1); };
            next.onclick=()=>{ haptic('selection'); go(1); };
            // keyboard
            container.tabIndex=0; container.addEventListener('keydown', (e)=>{ if(e.key==='ArrowLeft'){ e.preventDefault(); go(-1);} if(e.key==='ArrowRight'){ e.preventDefault(); go(1);} });
            // wheel to horizontal
            container.addEventListener('wheel',(e)=>{ if(Math.abs(e.deltaY)>Math.abs(e.deltaX)){ e.preventDefault(); go(e.deltaY>0? 1 : -1); } }, { passive:false });
          }
        }
        // touch swipe: within subgroup go to neighbor group at edges; circular
        try{
          let sx=0, sy=0, ex=0; slides.addEventListener('touchstart', (e)=>{ const t=e.touches[0]; sx=t.clientX; sy=t.clientY; ex=sx; }, {passive:true});
          slides.addEventListener('touchmove', (e)=>{ const t=e.touches[0]; ex=t.clientX; }, {passive:true});
          slides.addEventListener('touchend', ()=>{ const dx=ex - sx; if(Math.abs(dx)<40) return; const atStart = slides.scrollLeft <= 5; const atEnd = slides.scrollLeft >= (slides.scrollWidth - slides.clientWidth - 5); if(dx<0 && atEnd){ goGroup(1); } else if(dx>0 && atStart){ goGroup(-1); } });
        }catch(_){ }
      }
 
      // initialize
      // ensure equal slide widths after mount
      setTimeout(()=>{ setSeg(activeKey); }, 0);
      // re-render traffic on resize (desktop)
      try{ window.addEventListener('resize', ()=>{ try{ renderTrafficChart(); }catch(_){ } }); }catch(_){ }
    }
    // Traffic chart under buttons, only when subscription exists
    async function renderTrafficChart(){ try{ const wrap=document.getElementById('trafficCard'); const chart=document.getElementById('trafficChart'); if(!wrap||!chart) return; if(!HAS_SUB){ wrap.classList.add('hidden'); chart.innerHTML=''; const infoOld=document.getElementById('trafficTodayInfo'); if(infoOld) infoOld.textContent=''; return; } wrap.classList.remove('hidden'); // show loader
      let loader=document.getElementById('trafficLoader'); if(!loader){ loader=document.createElement('div'); loader.id='trafficLoader'; loader.className='text-xs'; loader.textContent='Загрузка трафика…'; wrap.insertBefore(loader, chart); }
      chart.style.filter='blur(2px)';
      const payload = CURRENT_SUB && CURRENT_SUB.client_id ? { client_id: CURRENT_SUB.client_id } : {}; const r=await api('traffic_chart', payload); if(!r.ok){ chart.style.filter='none'; loader.textContent='Нет данных по трафику'; return; } const data=await r.json(); const labels = Array.isArray(data.labels)?data.labels:[]; let vals = Array.isArray(data.values)?data.values:[]; if(!(labels.length && vals.length)){ chart.style.filter='none'; loader.textContent='Нет данных по трафику'; return; } // make chart cumulative so max equals total
      try{ if(typeof data.total==='number' && data.total>0){ let s=0; vals = vals.map(v=>{ s += Number(v)||0; return +s.toFixed(2); }); } }catch(_){ }
      chart.innerHTML=''; chart.style.minHeight='96px'; chart.style.height='96px'; const max = Math.max(...vals, 1); const w = chart.clientWidth||280; const h = 96; const themeLight = document.documentElement.classList.contains('light'); const lineColor = '#2963ff'; const axisLineColor = lineColor; const textColor = themeLight? '#0b0d14' : '#ffffff'; const titleEl = document.getElementById('trafficTitle'); if(titleEl){ titleEl.style.color = textColor; }
      const wrapInner=document.createElement('div'); wrapInner.style.width='100%'; wrapInner.style.display='flex'; wrapInner.style.flexDirection='column';
      // Grid: Y-axis + plot area
      const rowWrap=document.createElement('div'); rowWrap.style.display='grid'; rowWrap.style.gridTemplateColumns='32px 1fr'; rowWrap.style.columnGap='6px'; rowWrap.style.alignItems='end'; rowWrap.style.height=(h-22)+'px';
      // Y axis labels (text only)
      const yAxis=document.createElement('div'); yAxis.style.display='flex'; yAxis.style.flexDirection='column'; yAxis.style.justifyContent='space-between'; yAxis.style.height='100%'; yAxis.style.color = textColor; yAxis.style.fontSize='11px'; const yTop=document.createElement('div'); yTop.textContent = Math.round(max)+' ГБ'; const yMid=document.createElement('div'); yMid.textContent = Math.round(max/2)+' ГБ'; const yZero=document.createElement('div'); yZero.textContent = '0'; yAxis.appendChild(yTop); yAxis.appendChild(yMid); yAxis.appendChild(yZero);
      // Plot area
      const plotWrap=document.createElement('div'); plotWrap.style.position='relative'; plotWrap.style.height='100%'; plotWrap.style.borderBottom='1px solid '+axisLineColor; plotWrap.style.padding='0 4px';
      const svgNS='http://www.w3.org/2000/svg'; const svg=document.createElementNS(svgNS,'svg'); svg.setAttribute('width','100%'); svg.setAttribute('height','100%'); svg.setAttribute('fill','none'); svg.style.display='block'; plotWrap.appendChild(svg);
      rowWrap.appendChild(yAxis); rowWrap.appendChild(plotWrap);
      // Append rows and X labels
      const xRow=document.createElement('div'); xRow.style.display='flex'; xRow.style.alignItems='center'; xRow.style.justifyContent='space-between'; xRow.style.padding='4px 6px 0 38px'; xRow.style.color=textColor; xRow.style.fontSize='11px'; labels.forEach((lab)=>{ const span=document.createElement('span'); span.textContent=lab; span.style.flex='1'; span.style.textAlign='center'; xRow.appendChild(span); });
      wrapInner.appendChild(rowWrap); wrapInner.appendChild(xRow); chart.appendChild(wrapInner);
      // Draw line after DOM attach to get sizes
      const plotW = plotWrap.clientWidth - 8; const plotH = plotWrap.clientHeight - 4; const leftPad=4, rightPad=4, topPad=4, bottomPad=0; const innerW = Math.max(1, plotW - leftPad - rightPad); const innerH = Math.max(1, plotH - topPad - bottomPad);
      let d=''; for(let i=0;i<vals.length;i++){ const x = leftPad + (innerW * (vals.length>1? (i/(vals.length-1)) : 0)); const y = topPad + (innerH * (1 - (vals[i]/max))); d += (i===0? 'M':' L')+x.toFixed(1)+','+y.toFixed(1); }
      const path=document.createElementNS(svgNS,'path'); path.setAttribute('d', d); path.setAttribute('stroke', lineColor); path.setAttribute('stroke-width','2'); path.setAttribute('fill','none'); svg.appendChild(path);
      // Points
      for(let i=0;i<vals.length;i++){ const x = leftPad + (innerW * (vals.length>1? (i/(vals.length-1)) : 0)); const y = topPad + (innerH * (1 - (vals[i]/max))); const c=document.createElementNS(svgNS,'circle'); c.setAttribute('cx', x.toFixed(1)); c.setAttribute('cy', y.toFixed(1)); c.setAttribute('r','2'); c.setAttribute('fill', lineColor); svg.appendChild(c); }
      // Total info line
	  let info = document.getElementById('trafficTodayInfo'); if(!info){ info=document.createElement('div'); info.id='trafficTodayInfo'; info.className='mt-2 text-sm'; wrap.appendChild(info); } const total = (typeof data.total==='number') ? data.total : ((typeof data.today==='number')?data.today:(vals.length ? vals[vals.length-1] : 0)); const unit = (data.unit==='GB'?'ГБ':(data.unit||'ГБ')); info.innerHTML = 'Всего трафика: <span class="text-white font-semibold">'+Number(total||0).toFixed(2)+' '+unit+'</span>'; info.style.color = textColor; chart.style.filter='none'; if(loader){ loader.remove(); } try{ if(data.next_reset_ts){ const delay = Math.max(0, data.next_reset_ts*1000 - Date.now()); if(delay<36e5){ setTimeout(()=>{ try{ renderTrafficChart(); }catch(_){ } }, delay+1500); } } }catch(_){} }catch(_){ } }

    const iPaid=document.getElementById('iPaidBtn'); if(iPaid){ iPaid.onclick=async()=>{ haptic('medium'); try{ if(window.LAST_EXTEND && window.LAST_EXTEND.tariff_id){ const r=await api('extend', window.LAST_EXTEND); if(r.ok){ showToast('Подписка продлена'); setTimeout(()=>location.reload(),400); return; } }
        const r=await api('auto_renew_if_pending'); if(r.ok){ const js=await r.json().catch(()=>({})); if(js.status==='ok' || js.new_expiry_time){ showToast('Подписка продлена'); setTimeout(()=>location.reload(), 400); } else if(r.status===402 || js.status==='insufficient'){ alert('Недостаточно средств'); } else if(js.status==='noop'){ alert('Нет ожидающих продлений'); } else { alert('Проверка оплаты не подтвердила продление'); } } }catch(_){ alert('Ошибка проверки оплаты'); } } }
  </script>
</body>
</html>
